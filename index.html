<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>缘生故如幻</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="记录一些有意思的事。">
<meta property="og:type" content="website">
<meta property="og:title" content="缘生故如幻">
<meta property="og:url" content="https://jiyou.github.io/blog/index.html">
<meta property="og:site_name" content="缘生故如幻">
<meta property="og:description" content="记录一些有意思的事。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="缘生故如幻">
<meta name="twitter:description" content="记录一些有意思的事。">
  
    <link rel="alternative" href="/atom.xml" title="缘生故如幻" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/blog/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/blog//img/head.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">You Ji</a></h1>
		</hgroup>

		
		<p class="header-subtitle">心言直故，如是乃至始终地位，中间永无诸委曲相。</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/blog/">主页</a></li>
				        
							<li><a href="/blog/archives">所有文章</a></li>
				        
							<li><a href="/blog/categories/随笔">随笔</a></li>
				        
							<li><a href="/blog/categories/xv6">xv6</a></li>
				        
							<li><a href="/blog/categories/ceph">ceph</a></li>
				        
							<li><a href="/blog/categories/openstack">openstack</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/blog/tags/Ceph/" style="font-size: 10px;">Ceph</a> <a href="/blog/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/blog/tags/Gdb/" style="font-size: 10px;">Gdb</a> <a href="/blog/tags/JOS/" style="font-size: 20px;">JOS</a> <a href="/blog/tags/MIT-6-828/" style="font-size: 20px;">MIT 6.828</a> <a href="/blog/tags/OpenStack/" style="font-size: 10px;">OpenStack</a> <a href="/blog/tags/Qemu/" style="font-size: 10px;">Qemu</a> <a href="/blog/tags/ceph/" style="font-size: 20px;">ceph</a> <a href="/blog/tags/gdb/" style="font-size: 10px;">gdb</a> <a href="/blog/tags/qemu/" style="font-size: 10px;">qemu</a> <a href="/blog/tags/woboq/" style="font-size: 10px;">woboq</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">You Ji</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img lazy-src="/blog//img/head.png" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">You Ji</h1>
			</hgroup>
			
			<p class="header-subtitle">心言直故，如是乃至始终地位，中间永无诸委曲相。</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/blog/">主页</a></li>
		        
					<li><a href="/blog/archives">所有文章</a></li>
		        
					<li><a href="/blog/categories/随笔">随笔</a></li>
		        
					<li><a href="/blog/categories/xv6">xv6</a></li>
		        
					<li><a href="/blog/categories/ceph">ceph</a></li>
		        
					<li><a href="/blog/categories/openstack">openstack</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-ceph-rbd-process" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/30/ceph-rbd-process/" class="article-date">
  	<time datetime="2016-09-30T07:02:55.000Z" itemprop="datePublished">2016-09-30</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/30/ceph-rbd-process/">ceph.rbd.process</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h1><p>当按照文章建立好debug的环境后，就可以开始进行debug工作了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">gdb --dir=/opt/ceph -tui --args /usr/bin/qemu-system-x86_64 -name h1 -m 126 -drive file=/cloud/h1/ubuntu-h1.qcow2,<span class="keyword">if</span>=none,id=drive-virtio-disk0,format=qcow2 -vnc 0.0.0.0:0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x6,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive <span class="string">"file=rbd:rbd/new-libvirt-image:id=admin:key=AQCe3eFXc5sPIRAAAkQ2jgKKefBZQFE5X2FxCg==:auth_supported=cephx\;none:mon_host=10.64.218.106\:6789,if=none,id=drive-virtio-disk1"</span> -device <span class="string">"virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk1,id=virtio-disk1"</span></div></pre></td></tr></table></figure>
<p>启动之后，击回车，然后设置两个断点。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">break</span> main</div><div class="line"><span class="built_in">break</span> rbd.c:621</div></pre></td></tr></table></figure>
<h1 id="启动Debug"><a href="#启动Debug" class="headerlink" title="启动Debug"></a>启动Debug</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">start <span class="comment"># 开始执行程序</span></div><div class="line">c  <span class="comment"># &lt;- 第一次会停在main函数这里。</span></div><div class="line"></div><div class="line">Breakpoint 2, rbd_start_aio (bs=0x5555564c44a0, sector_num=0, qiov=0x7fffffffcf40, nb_sectors=4,</div><div class="line">    cb=0x55555560bcb1 &lt;bdrv_co_io_em_complete&gt;, opaque=0x7fffd4099d60, cmd=RBD_AIO_READ) at block/rbd.c:625   <span class="comment">#&lt;-- 已经进入到rbd代码部分。</span></div></pre></td></tr></table></figure>
<h1 id="Qemu-rbd-c-rbd-start-aio"><a href="#Qemu-rbd-c-rbd-start-aio" class="headerlink" title="Qemu:rbd.c:rbd_start_aio()"></a>Qemu:rbd.c:rbd_start_aio()</h1><p>由于<code>debug</code>是设置在<code>rbd.c:621</code>。所以首先会进入到<code>rbd_start_aio</code>函数中。这个函数主要是负责<code>rbd</code>的读写操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">static BlockAIOCB *rbd_start_aio(BlockDriverState *bs,</div><div class="line">                                 int64_t sector_num,</div><div class="line">                                 QEMUIOVector *qiov,</div><div class="line">                                 int nb_sectors,</div><div class="line">                                 BlockCompletionFunc *cb,</div><div class="line">                                 void *opaque,</div><div class="line">                                 RBDAIOCmd cmd)</div><div class="line">&#123;</div><div class="line">	....</div><div class="line">    switch (cmd) &#123;</div><div class="line">    <span class="keyword">case</span> RBD_AIO_WRITE:</div><div class="line">        r = rbd_aio_write(s-&gt;image, off, size, buf, c);</div><div class="line">        <span class="built_in">break</span>;</div><div class="line">    <span class="keyword">case</span> RBD_AIO_READ:  // &lt;-- 刚启动的时候会到<span class="built_in">read</span>这里来。</div><div class="line">        r = rbd_aio_read(s-&gt;image, off, size, buf, c);</div><div class="line">        <span class="built_in">break</span>;</div><div class="line">    <span class="keyword">case</span> RBD_AIO_DISCARD:</div><div class="line">        r = rbd_aio_discard_wrapper(s-&gt;image, off, size, c);</div><div class="line">        <span class="built_in">break</span>;</div><div class="line">    <span class="keyword">case</span> RBD_AIO_FLUSH:</div><div class="line">        r = rbd_aio_flush_wrapper(s-&gt;image, c);</div><div class="line">        <span class="built_in">break</span>;</div><div class="line">    default:</div><div class="line">        r = -EINVAL;</div><div class="line">    &#125;</div><div class="line">    ....</div></pre></td></tr></table></figure>
<h1 id="librbd-librbd-cc-2632-rbd-aio-read"><a href="#librbd-librbd-cc-2632-rbd-aio-read" class="headerlink" title="librbd/librbd.cc:2632:rbd_aio_read()"></a>librbd/librbd.cc:2632:rbd_aio_read()</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"> |2628    extern <span class="string">"C"</span> int rbd_aio_read(rbd_image_t image, uint64_t off, size_t len,                                                   |</div><div class="line"> |2629                                char *buf, rbd_completion_t c)                                                                 |</div><div class="line"> |2630    &#123;                                                                                                                          |</div><div class="line"> |2631      librbd::ImageCtx *ictx = (librbd::ImageCtx *)image;                                                                      |</div><div class="line">&gt;|2632      librbd::RBD::AioCompletion *comp = (librbd::RBD::AioCompletion *)c;                                                      |</div><div class="line"> |2633      tracepoint(librbd, aio_read_enter, ictx, ictx-&gt;name.c_str(), ictx-&gt;snap_name.c_str(), ictx-&gt;read_only, off, len, buf, com|</div><div class="line"> |2634      ictx-&gt;aio_work_queue-&gt;aio_read(get_aio_completion(comp), off, len, buf, NULL,                                            |</div><div class="line"> |2635                                     0);                                                                                       |</div><div class="line"> |2636      tracepoint(librbd, aio_read_exit, 0);                                                                                    |</div><div class="line"> |2637      <span class="built_in">return</span> 0;                                                                                                                |</div><div class="line"> |2638    &#125;</div></pre></td></tr></table></figure>
<p>这里只是利用ictx的<code>aio_read</code>，所以直接进入到<code>aio_read</code>进行读取：</p>
<h1 id="librbd-AioImageRequestWQ-cc-96-aio-read"><a href="#librbd-AioImageRequestWQ-cc-96-aio-read" class="headerlink" title="librbd/AioImageRequestWQ.cc:96:aio_read()"></a>librbd/AioImageRequestWQ.cc:96:aio_read()</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h1 id="common-WorkQueue-cc-133-ThreadPool-worker"><a href="#common-WorkQueue-cc-133-ThreadPool-worker" class="headerlink" title="common/WorkQueue.cc:133:ThreadPool::worker()"></a>common/WorkQueue.cc:133:ThreadPool::worker()</h1><p>前面的操作，都是把<code>Request</code>放到一个<code>Queue</code>里面。然后利用线程来进行处理。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="keyword">void</span> ThreadPool::worker(WorkThread *wt)</div><div class="line">&#123;</div><div class="line">  <span class="number">_l</span>ock.Lock();</div><div class="line">  ldout(cct,<span class="number">10</span>) &lt;&lt; <span class="string">"worker start"</span> &lt;&lt; dendl;</div><div class="line"></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">stringstream</span> ss;</div><div class="line">  <span class="keyword">char</span> name[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(__FreeBSD__)</span></div><div class="line">  pthread_getname_np(pthread_self(), name, <span class="keyword">sizeof</span>(name));</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  ss &lt;&lt; name &lt;&lt; <span class="string">" thread "</span> &lt;&lt; name;</div><div class="line">  heartbeat_handle_d *hb = cct-&gt;get_heartbeat_map()-&gt;add_worker(ss.str(), pthread_self());</div><div class="line"></div><div class="line">  <span class="keyword">while</span> (!<span class="number">_</span>stop) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// manage dynamic thread pool</span></div><div class="line">    join_old_threads();</div><div class="line">    <span class="keyword">if</span> (<span class="number">_</span>threads.size() &gt; <span class="number">_</span>num_threads) &#123;</div><div class="line">      ldout(cct,<span class="number">1</span>) &lt;&lt; <span class="string">" worker shutting down; too many threads ("</span> &lt;&lt; <span class="number">_</span>threads.size() &lt;&lt; <span class="string">" &gt; "</span> &lt;&lt; <span class="number">_</span>num_threads &lt;&lt; <span class="string">")"</span> &lt;&lt; dendl;</div><div class="line">      <span class="number">_</span>threads.erase(wt);</div><div class="line">      <span class="number">_</span>old_threads.push_back(wt);</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="number">_</span>pause &amp;&amp; !work_queues.empty()) &#123;</div><div class="line">      WorkQueue_* wq;</div><div class="line">      <span class="keyword">int</span> tries = work_queues.size();</div><div class="line">      <span class="keyword">bool</span> did = <span class="literal">false</span>;</div><div class="line">      <span class="keyword">while</span> (tries--) &#123;</div><div class="line">	last_work_queue++;</div><div class="line">	last_work_queue %= work_queues.size();</div><div class="line">	wq = work_queues[last_work_queue];</div><div class="line"></div><div class="line">	<span class="keyword">void</span> *item = wq-&gt;<span class="number">_</span>void_dequeue();</div><div class="line">	<span class="keyword">if</span> (item) &#123;</div><div class="line">	  processing++;</div><div class="line">	  ldout(cct,<span class="number">12</span>) &lt;&lt; <span class="string">"worker wq "</span> &lt;&lt; wq-&gt;name &lt;&lt; <span class="string">" start processing "</span> &lt;&lt; item</div><div class="line">			&lt;&lt; <span class="string">" ("</span> &lt;&lt; processing &lt;&lt; <span class="string">" active)"</span> &lt;&lt; dendl;</div><div class="line">	  <span class="function">TPHandle <span class="title">tp_handle</span><span class="params">(cct, hb, wq-&gt;timeout_interval, wq-&gt;suicide_interval)</span></span>;</div><div class="line">	  tp_handle.reset_tp_timeout();</div><div class="line">	  <span class="number">_l</span>ock.Unlock();</div><div class="line">	  wq-&gt;<span class="number">_</span>void_process(item, tp_handle);  <span class="comment">// &lt;-- 这里对请求进行处理。</span></div><div class="line">	  <span class="number">_l</span>ock.Lock();</div><div class="line">	  wq-&gt;<span class="number">_</span>void_process_finish(item);</div><div class="line">	  processing--;</div><div class="line">	  ldout(cct,<span class="number">15</span>) &lt;&lt; <span class="string">"worker wq "</span> &lt;&lt; wq-&gt;name &lt;&lt; <span class="string">" done processing "</span> &lt;&lt; item</div><div class="line">			&lt;&lt; <span class="string">" ("</span> &lt;&lt; processing &lt;&lt; <span class="string">" active)"</span> &lt;&lt; dendl;</div><div class="line">	  <span class="keyword">if</span> (<span class="number">_</span>pause || <span class="number">_</span>draining)</div><div class="line">	    <span class="number">_</span>wait_cond.Signal();</div><div class="line">	  did = <span class="literal">true</span>;</div><div class="line">	  <span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (did)</div><div class="line">	<span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ldout(cct,<span class="number">20</span>) &lt;&lt; <span class="string">"worker waiting"</span> &lt;&lt; dendl;</div><div class="line">    cct-&gt;get_heartbeat_map()-&gt;reset_timeout(</div><div class="line">      hb,</div><div class="line">      cct-&gt;<span class="number">_</span>conf-&gt;threadpool_default_timeout,</div><div class="line">      <span class="number">0</span>);</div><div class="line">    <span class="number">_</span>cond.WaitInterval(cct, <span class="number">_l</span>ock,</div><div class="line">      <span class="keyword">utime_t</span>(</div><div class="line">	cct-&gt;<span class="number">_</span>conf-&gt;threadpool_empty_queue_max_wait, <span class="number">0</span>));</div><div class="line">  &#125;</div><div class="line">  ldout(cct,<span class="number">1</span>) &lt;&lt; <span class="string">"worker finish"</span> &lt;&lt; dendl;</div><div class="line"></div><div class="line">  cct-&gt;get_heartbeat_map()-&gt;remove_worker(hb);</div><div class="line"></div><div class="line">  <span class="number">_l</span>ock.Unlock();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="librbd-AioImageRequest-cc-131-send"><a href="#librbd-AioImageRequest-cc-131-send" class="headerlink" title="librbd/AioImageRequest.cc:131:send()"></a>librbd/AioImageRequest.cc:131:send()</h1><figure class="highlight c"><table><tr><td class="code"><pre><div class="line"> |<span class="number">130</span>     <span class="keyword">template</span> &lt;<span class="keyword">typename</span> I&gt;                                                                                                      |</div><div class="line">&gt;|<span class="number">131</span>     <span class="keyword">void</span> AioImageRequest&lt;I&gt;::send() &#123;                                                                                          |</div><div class="line"> |<span class="number">132</span>       assert(m_image_ctx.owner_lock.is_locked());                                                                              |</div><div class="line"> |<span class="number">133</span>                                                                                                                                |</div><div class="line"> |<span class="number">134</span>       CephContext *cct = m_image_ctx.cct;                                                                                      |</div><div class="line"> |<span class="number">135</span>       ldout(cct, <span class="number">20</span>) &lt;&lt; get_request_type() &lt;&lt; <span class="string">": ictx="</span> &lt;&lt; &amp;m_image_ctx &lt;&lt; <span class="string">", "</span>                                                |</div><div class="line"> |<span class="number">136</span>                      &lt;&lt; <span class="string">"completion="</span> &lt;&lt; m_aio_comp &lt;&lt;  dendl;                                                                 |</div><div class="line"> |<span class="number">137</span>                                                                                                                                |</div><div class="line"> |<span class="number">138</span>       m_aio_comp-&gt;get();                                                                                                       |</div><div class="line"> |<span class="number">139</span>       send_request();                                                                                                          |</div><div class="line"> |<span class="number">140</span>     &#125;</div></pre></td></tr></table></figure>
<h1 id="librbd-AioImageRequest-cc-148-send-request"><a href="#librbd-AioImageRequest-cc-148-send-request" class="headerlink" title="librbd/AioImageRequest.cc:148:send_request()"></a>librbd/AioImageRequest.cc:148:send_request()</h1><figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="keyword">void</span> AioImageRead::send_request() &#123;</div><div class="line">  CephContext *cct = m_image_ctx.cct;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (m_image_ctx.object_cacher &amp;&amp; m_image_ctx.readahead_max_bytes &gt; <span class="number">0</span> &amp;&amp;</div><div class="line">      !(m_op_flags &amp; LIBRADOS_OP_FLAG_FADVISE_RANDOM)) &#123;</div><div class="line">    readahead(&amp;m_image_ctx, m_image_extents);  <span class="comment">// interal.cc:3578:readahead()</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  librados::<span class="keyword">snap_t</span> snap_id;</div><div class="line">  <span class="built_in">map</span>&lt;<span class="keyword">object_t</span>,<span class="built_in">vector</span>&lt;ObjectExtent&gt; &gt; object_extents;</div><div class="line">  <span class="keyword">uint64_t</span> buffer_ofs = <span class="number">0</span>;</div><div class="line">  &#123;</div><div class="line">    <span class="comment">// prevent image size from changing between computing clip and recording</span></div><div class="line">    <span class="comment">// pending async operation</span></div><div class="line">    RWLock::<span class="function">RLocker <span class="title">snap_locker</span><span class="params">(m_image_ctx.snap_lock)</span></span>;</div><div class="line">    snap_id = m_image_ctx.snap_id;</div><div class="line"></div><div class="line">    <span class="comment">// map</span></div><div class="line">    <span class="keyword">for</span> (<span class="built_in">vector</span>&lt;pair&lt;<span class="keyword">uint64_t</span>,<span class="keyword">uint64_t</span>&gt; &gt;::const_iterator p =</div><div class="line">           m_image_extents.begin();</div><div class="line">         p != m_image_extents.end(); ++p) &#123;</div><div class="line">      <span class="keyword">uint64_t</span> len = p-&gt;second;</div><div class="line">      <span class="keyword">int</span> r = clip_io(&amp;m_image_ctx, p-&gt;first, &amp;len);</div><div class="line">      <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</div><div class="line">        m_aio_comp-&gt;fail(r);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Striper::file_to_extents(cct, m_image_ctx.format_string,</div><div class="line">                               &amp;m_image_ctx.layout, p-&gt;first, len, <span class="number">0</span>,</div><div class="line">                               object_extents, buffer_ofs);</div><div class="line">      buffer_ofs += len;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  m_aio_comp-&gt;read_buf = m_buf;</div><div class="line">  m_aio_comp-&gt;read_buf_len = buffer_ofs;</div><div class="line">  m_aio_comp-&gt;read_bl = m_pbl;</div><div class="line"></div><div class="line">  <span class="comment">// pre-calculate the expected number of read requests</span></div><div class="line">  <span class="keyword">uint32_t</span> request_count = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;object_extent : object_extents) &#123;</div><div class="line">    request_count += object_extent.second.size();</div><div class="line">  &#125;</div><div class="line">  m_aio_comp-&gt;set_request_count(request_count);</div><div class="line"></div><div class="line">  <span class="comment">// issue the requests</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;object_extent : object_extents) &#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;extent : object_extent.second) &#123;</div><div class="line">      ldout(cct, <span class="number">20</span>) &lt;&lt; <span class="string">" oid "</span> &lt;&lt; extent.oid &lt;&lt; <span class="string">" "</span> &lt;&lt; extent.offset &lt;&lt; <span class="string">"~"</span></div><div class="line">                     &lt;&lt; extent.length &lt;&lt; <span class="string">" from "</span> &lt;&lt; extent.buffer_extents</div><div class="line">                     &lt;&lt; dendl;</div><div class="line"></div><div class="line">      C_AioRead *req_comp = <span class="keyword">new</span> C_AioRead(m_aio_comp);</div><div class="line">      AioObjectRead *req = <span class="keyword">new</span> AioObjectRead(&amp;m_image_ctx, extent.oid.name,</div><div class="line">                                             extent.objectno, extent.offset,</div><div class="line">                                             extent.length,</div><div class="line">                                             extent.buffer_extents, snap_id,</div><div class="line">                                             <span class="literal">true</span>, req_comp, m_op_flags);</div><div class="line">      req_comp-&gt;set_req(req);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (m_image_ctx.object_cacher) &#123;</div><div class="line">        C_CacheRead *cache_comp = <span class="keyword">new</span> C_CacheRead(&amp;m_image_ctx, req);</div><div class="line">        m_image_ctx.aio_read_from_cache(extent.oid, extent.objectno,</div><div class="line">                                        &amp;req-&gt;data(), extent.length,</div><div class="line">                                        extent.offset, cache_comp, m_op_flags);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        req-&gt;send();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  m_aio_comp-&gt;put();</div><div class="line"></div><div class="line">  m_image_ctx.perfcounter-&gt;inc(l_librbd_rd);</div><div class="line">  m_image_ctx.perfcounter-&gt;inc(l_librbd_rd_bytes, buffer_ofs);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于<code>readahead</code>算法，以及思路可以查看：<a href="http://os.51cto.com/art/200910/159067_all.htm。" target="_blank" rel="external">http://os.51cto.com/art/200910/159067_all.htm。</a><br>并且在这里有关于<code>librbd/readahead</code>的一个说明：<a href="http://docs.ceph.com/docs/jewel/rbd/rbd-config-ref/" target="_blank" rel="external">http://docs.ceph.com/docs/jewel/rbd/rbd-config-ref/</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Ceph/">Ceph</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Gdb/">Gdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Qemu/">Qemu</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/blog/categories/Ceph/">Ceph</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-ceph-rbd-process" data-title="ceph.rbd.process" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-ceph-debug" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/29/ceph-debug/" class="article-date">
  	<time datetime="2016-09-29T12:39:31.000Z" itemprop="datePublished">2016-09-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/29/ceph-debug/">Qemu RBD调试Ceph</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这里主要是介绍如何使用<code>qemu/rbd</code>调试ceph关于rbd模块的代码。调试过程如下：</p>
<ul>
<li>vm:ubuntu 14.04</li>
<li>docker</li>
</ul>
<h1 id="安装计划"><a href="#安装计划" class="headerlink" title="安装计划"></a>安装计划</h1><p>这里说一下安装计划，由于考虑到只是开发环境，为了简单，只使用一台虚拟机。</p>
<ul>
<li>虚拟机里面安装<code>docker</code>。</li>
<li>ceph安装在一个docker中。</li>
<li>虚拟机在编译安装qemu/ceph。</li>
</ul>
<h1 id="设置源"><a href="#设置源" class="headerlink" title="设置源"></a>设置源</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">deb http://us.archive.ubuntu.com/ubuntu/ trusty main restricted</div><div class="line">deb-src http://us.archive.ubuntu.com/ubuntu/ trusty main restricted</div><div class="line">deb http://us.archive.ubuntu.com/ubuntu/ trusty-updates main restricted</div><div class="line">deb-src http://us.archive.ubuntu.com/ubuntu/ trusty-updates main restricted</div><div class="line">deb http://us.archive.ubuntu.com/ubuntu/ trusty universe</div><div class="line">deb-src http://us.archive.ubuntu.com/ubuntu/ trusty universe</div><div class="line">deb http://us.archive.ubuntu.com/ubuntu/ trusty-updates universe</div><div class="line">deb-src http://us.archive.ubuntu.com/ubuntu/ trusty-updates universe</div><div class="line">deb http://us.archive.ubuntu.com/ubuntu/ trusty multiverse</div><div class="line">deb-src http://us.archive.ubuntu.com/ubuntu/ trusty multiverse</div><div class="line">deb http://us.archive.ubuntu.com/ubuntu/ trusty-updates multiverse</div><div class="line">deb-src http://us.archive.ubuntu.com/ubuntu/ trusty-updates multiverse</div><div class="line">deb http://us.archive.ubuntu.com/ubuntu/ trusty-backports main restricted universe multiverse</div><div class="line">deb-src http://us.archive.ubuntu.com/ubuntu/ trusty-backports main restricted universe multiverse</div><div class="line">deb http://security.ubuntu.com/ubuntu trusty-security main restricted</div><div class="line">deb-src http://security.ubuntu.com/ubuntu trusty-security main restricted</div><div class="line">deb http://security.ubuntu.com/ubuntu trusty-security universe</div><div class="line">deb-src http://security.ubuntu.com/ubuntu trusty-security universe</div><div class="line">deb http://security.ubuntu.com/ubuntu trusty-security multiverse</div><div class="line">deb-src http://security.ubuntu.com/ubuntu trusty-security multiverse</div></pre></td></tr></table></figure>
<p>然后运行<code>apt-get update</code>。</p>
<h1 id="准备磁盘空间"><a href="#准备磁盘空间" class="headerlink" title="准备磁盘空间"></a>准备磁盘空间</h1><p>先准备足够的磁盘空间：<code>如果没有/dev/vdd</code>，则跳过此步骤。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mkfs.ext4 /dev/vdd  <span class="comment"># 这里换成自己的磁盘。</span></div><div class="line">mkdir -p /var/lib/docker</div><div class="line">mount /dev/vdd /var/lib/docker</div></pre></td></tr></table></figure>
<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>一条命令安装<code>Docker</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">wget -qO- https://get.docker.com | sh</div></pre></td></tr></table></figure>
<h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>源码主要分两部分：</p>
<ul>
<li>ceph</li>
<li>qemu</li>
</ul>
<h3 id="Ceph下载源码"><a href="#Ceph下载源码" class="headerlink" title="Ceph下载源码"></a>Ceph下载源码</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /var/lib/docker</div><div class="line">apt-get install -y git</div><div class="line">git <span class="built_in">clone</span> https://github.com/ceph/ceph.git</div><div class="line"><span class="built_in">cd</span> ceph</div><div class="line">git checkout v11.0.0</div><div class="line">./install-deps.sh</div></pre></td></tr></table></figure>
<h3 id="下载Qemu源码"><a href="#下载Qemu源码" class="headerlink" title="下载Qemu源码"></a>下载Qemu源码</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get <span class="built_in">source</span> qemu</div></pre></td></tr></table></figure>
<h1 id="Ceph-on-Docker"><a href="#Ceph-on-Docker" class="headerlink" title="Ceph on Docker"></a>Ceph on Docker</h1><p>安装<code>docker-enter</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y build-essential</div><div class="line"><span class="built_in">cd</span> /tmp; curl https://www.kernel.org/pub/linux/utils/util-linux/v2.24/util-linux-2.24.tar.gz | tar -zxf-; <span class="built_in">cd</span> util-linux-2.24;</div><div class="line">./configure --without-ncurses</div><div class="line">make nsenter &amp;&amp; sudo cp nsenter /usr/<span class="built_in">local</span>/bin</div></pre></td></tr></table></figure>
<p>添加两条命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="keyword">function</span> docker-<span class="function"><span class="title">enter</span></span>() &#123;</div><div class="line">    PID=$(docker inspect --format <span class="string">"&#123;&#123; .State.Pid &#125;&#125;"</span> <span class="variable">$1</span>)</div><div class="line">    nsenter --target <span class="variable">$PID</span> --mount --uts --ipc --net --pid</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">cip</span></span>() &#123;</div><div class="line">    docker inspect --format <span class="string">'&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;'</span> <span class="variable">$1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="安装Ceph-v11-0-0-Package"><a href="#安装Ceph-v11-0-0-Package" class="headerlink" title="安装Ceph v11.0.0 Package"></a>安装Ceph v11.0.0 Package</h2><p><code>Host</code>机器上安装Ceph包。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">. /etc/profile</div><div class="line">apt-get update</div><div class="line">apt-get install lsb-release lsb-base vim</div><div class="line"><span class="built_in">echo</span> deb http://gitbuilder.ceph.com/ceph-deb-$(lsb_release -sc)-x86_64-basic/ref/v11.0.0 $(lsb_release -sc) main | tee /etc/apt/sources.list.d/ceph.list</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;addkey</div><div class="line">gpg --keyserver keyserver.ubuntu.com --recv <span class="variable">$1</span></div><div class="line">gpg --keyserver keyserver.debian.com --recv-keys <span class="variable">$1</span></div><div class="line">gpg --export --armor <span class="variable">$1</span> | apt-key add -</div><div class="line">EOF</div><div class="line"></div><div class="line">chmod +x addkey</div><div class="line">mkdir -p /home/youji <span class="comment"># 这里要改成自己的用户名</span></div><div class="line">./addkey 6EAEAE2203C3951A</div><div class="line">apt-get update</div><div class="line">apt-get install -y ceph ceph-common ipcalc net-tools uuid-runtime</div></pre></td></tr></table></figure>
<h2 id="安装Ceph"><a href="#安装Ceph" class="headerlink" title="安装Ceph"></a>安装Ceph</h2><h3 id="制作docker-image"><a href="#制作docker-image" class="headerlink" title="制作docker image"></a>制作docker image</h3><p>建立一个docker工作目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> ~/</div><div class="line">mkdir -p ceph.inst</div><div class="line"><span class="built_in">cd</span> ~/ceph.inst</div></pre></td></tr></table></figure>
<h3 id="addkey"><a href="#addkey" class="headerlink" title="addkey"></a>addkey</h3><p>添加<code>addkey</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;addkey</div><div class="line">gpg --keyserver keyserver.ubuntu.com --recv <span class="variable">$1</span></div><div class="line">gpg --keyserver keyserver.debian.com --recv-keys <span class="variable">$1</span></div><div class="line">gpg --export --armor <span class="variable">$1</span> | apt-key add -</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>准备<code>Dockerfile</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment"># DOCKER-VERSION 1.0.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Ceph Demo AIO</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># VERSION 0.0.1</span></div><div class="line"></div><div class="line">FROM ubuntu:14.04</div><div class="line">MAINTAINER Jerry.Ji <span class="string">"youji@ebay.com"</span></div><div class="line"></div><div class="line"><span class="comment"># Install s3cmd to support creation of buckets</span></div><div class="line">RUN apt-get -y update</div><div class="line">RUN apt-get install -y git wget vim python-dev ipcalc uuid-runtime rpcbind libc6-dbg gdb valgrind lsb-release lsb-base vim</div><div class="line">RUN <span class="built_in">echo</span> deb http://gitbuilder.ceph.com/ceph-deb-$(lsb_release -sc)-x86_64-basic/ref/v11.0.0 $(lsb_release -sc) main | tee /etc/apt/sources.list.d/ceph.list</div><div class="line">RUN apt-get update</div><div class="line"></div><div class="line">ADD addkey /addkey</div><div class="line">ADD entrypoint.sh /entrypoint.sh</div><div class="line"></div><div class="line">RUN chmod +x /entrypoint.sh</div><div class="line">RUN chmod +x /addkey</div><div class="line">RUN mkdir -p /home/youji</div><div class="line">RUN <span class="keyword">if</span> ! <span class="_">-e</span> /6EAEAE2203C3951A ; <span class="keyword">then</span>  touch /6EAEAE2203C3951A &amp;&amp; /addkey 6EAEAE2203C3951A ; <span class="keyword">fi</span></div><div class="line">RUN apt-get update &amp;&amp; apt-get install -y ceph ceph-common ipcalc net-tools uuid-runtime radosgw radosgw-dbg rpcbind nfs-common libcephfs-dev</div><div class="line"></div><div class="line"><span class="comment"># Add volumes for Ceph config and data</span></div><div class="line">VOLUME [<span class="string">"/etc/ceph"</span>,<span class="string">"/var/lib/ceph"</span>, <span class="string">"/opt"</span>]</div><div class="line"></div><div class="line"><span class="comment"># Expose the Ceph ports</span></div><div class="line">EXPOSE 6789 6800 6801 6802 6803 6804 6805 80 5000 22</div><div class="line"></div><div class="line"><span class="comment"># Execute the entrypoint</span></div><div class="line">ENTRYPOINT [<span class="string">"/entrypoint.sh"</span>]</div><div class="line"><span class="comment">#ENTRYPOINT ["/bin/bash"]</span></div></pre></td></tr></table></figure>
<h3 id="entrypoint-sh"><a href="#entrypoint-sh" class="headerlink" title="entrypoint.sh"></a>entrypoint.sh</h3><p>安装脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">set</span> <span class="_">-e</span></div><div class="line"></div><div class="line">: <span class="variable">$&#123;CLUSTER:=ceph&#125;</span></div><div class="line">: <span class="variable">$&#123;RGW_NAME:=$(hostname -s)&#125;</span></div><div class="line">: <span class="variable">$&#123;MON_NAME:=$(hostname -s)&#125;</span></div><div class="line">: <span class="variable">$&#123;RGW_CIVETWEB_PORT:=80&#125;</span></div><div class="line">: <span class="variable">$&#123;NETWORK_AUTO_DETECT:=0&#125;</span></div><div class="line"></div><div class="line"></div><div class="line">local_ip=$(ifconfig eth0 | grep <span class="string">"inet addr"</span> | awk -F : <span class="string">'&#123;print $2&#125;'</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</div><div class="line">local_cidr=$(ipcalc -n <span class="variable">$local_ip</span> 255.255.255.0 | grep <span class="string">"Network"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</div><div class="line">MON_IP=<span class="variable">$local_ip</span></div><div class="line">CEPH_NETWORK=<span class="variable">$local_cidr</span></div><div class="line">CEPH_PUBLIC_NETWORK=<span class="variable">$local_cidr</span></div><div class="line"></div><div class="line">CEPH_OPTS=<span class="string">"--cluster <span class="variable">$&#123;CLUSTER&#125;</span>"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># FUNCTIONS</span></div><div class="line"><span class="keyword">function</span> create_socket_dir &#123;</div><div class="line">  mkdir -p /var/run/ceph</div><div class="line">  chown ceph. /var/run/ceph</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#######</span></div><div class="line"><span class="comment"># MON #</span></div><div class="line"><span class="comment">#######</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> bootstrap_mon &#123;</div><div class="line">  <span class="keyword">if</span> [[ ! -n <span class="string">"<span class="variable">$CEPH_PUBLIC_NETWORK</span>"</span> &amp;&amp; <span class="variable">$&#123;NETWORK_AUTO_DETECT&#125;</span> <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"ERROR- CEPH_PUBLIC_NETWORK must be defined as the name of the network for the OSDs"</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> [[ ! -n <span class="string">"<span class="variable">$MON_IP</span>"</span> &amp;&amp; <span class="variable">$&#123;NETWORK_AUTO_DETECT&#125;</span> <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"ERROR- MON_IP must be defined as the IP address of the monitor"</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> [ <span class="variable">$&#123;NETWORK_AUTO_DETECT&#125;</span> <span class="_">-ne</span> 0 ]; <span class="keyword">then</span></div><div class="line">    NIC_MORE_TRAFFIC=$(grep -vE <span class="string">"lo:|face|Inter"</span> /proc/net/dev | sort -n -k 2 | tail -1 | awk <span class="string">'&#123; sub (":", "", $1); print $1 &#125;'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="built_in">command</span> -v ip; <span class="keyword">then</span></div><div class="line">      <span class="keyword">if</span> [ <span class="variable">$&#123;NETWORK_AUTO_DETECT&#125;</span> <span class="_">-eq</span> 1 ]; <span class="keyword">then</span></div><div class="line">        MON_IP=$(ip -6 -o a s <span class="variable">$NIC_MORE_TRAFFIC</span> | awk <span class="string">'&#123; sub ("/..", "", $4); print $4 &#125;'</span>)</div><div class="line">        <span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$MON_IP</span>"</span> ]; <span class="keyword">then</span></div><div class="line">          MON_IP=$(ip -4 -o a s <span class="variable">$NIC_MORE_TRAFFIC</span> | awk <span class="string">'&#123; sub ("/..", "", $4); print $4 &#125;'</span>)</div><div class="line">          CEPH_PUBLIC_NETWORK=$(ip r | grep -o <span class="string">'[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/[0-9]\&#123;1,2\&#125;'</span> | head -1)</div><div class="line">        <span class="keyword">fi</span></div><div class="line">      <span class="keyword">elif</span> [ <span class="variable">$&#123;NETWORK_AUTO_DETECT&#125;</span> <span class="_">-eq</span> 4 ]; <span class="keyword">then</span></div><div class="line">        MON_IP=$(ip -4 -o a s <span class="variable">$NIC_MORE_TRAFFIC</span> | awk <span class="string">'&#123; sub ("/..", "", $4); print $4 &#125;'</span>)</div><div class="line">        CEPH_PUBLIC_NETWORK=$(ip r | grep -o <span class="string">'[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/[0-9]\&#123;1,2\&#125;'</span> | head -1)</div><div class="line">      <span class="keyword">elif</span> [ <span class="variable">$&#123;NETWORK_AUTO_DETECT&#125;</span> <span class="_">-eq</span> 6 ]; <span class="keyword">then</span></div><div class="line">        MON_IP=$(ip -6 -o a s <span class="variable">$NIC_MORE_TRAFFIC</span> | awk <span class="string">'&#123; sub ("/..", "", $4); print $4 &#125;'</span>)</div><div class="line">        CEPH_PUBLIC_NETWORK=$(ip r | grep -o <span class="string">'[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/[0-9]\&#123;1,2\&#125;'</span> | head -1)</div><div class="line">      <span class="keyword">fi</span></div><div class="line">    <span class="comment"># best effort, only works with ipv4</span></div><div class="line">    <span class="comment"># it is tough to find the ip from the nic only using /proc</span></div><div class="line">    <span class="comment"># so we just take on of the addresses available</span></div><div class="line">    <span class="comment"># which is fairely safe given that containers usually have a single nic</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">      MON_IP=$(grep -o <span class="string">'[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;'</span> /proc/net/fib_trie | grep -vEw <span class="string">"^127|255$|0$"</span> | head -1)</div><div class="line">      CEPH_PUBLIC_NETWORK=$(grep -o <span class="string">'[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;\.[0-9]\&#123;1,3\&#125;/[0-9]\&#123;1,2\&#125;'</span> /proc/net/fib_trie | grep -vE <span class="string">"^127|^0"</span> | head -1)</div><div class="line">    <span class="keyword">fi</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$MON_IP</span>"</span> || -z <span class="string">"<span class="variable">$CEPH_PUBLIC_NETWORK</span>"</span> ]]; <span class="keyword">then</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"ERROR- it looks like we have not been able to discover the network settings"</span></div><div class="line">    <span class="built_in">exit</span> 1</div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="comment"># bootstrap MON</span></div><div class="line">  <span class="keyword">if</span> [ ! <span class="_">-e</span> /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.conf ]; <span class="keyword">then</span></div><div class="line">    fsid=$(uuidgen)</div><div class="line">    cat &lt;&lt;ENDHERE &gt;/etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.conf</div><div class="line">[global]</div><div class="line">fsid = <span class="variable">$fsid</span></div><div class="line">mon initial members = <span class="variable">$&#123;MON_NAME&#125;</span></div><div class="line">mon host = <span class="variable">$&#123;MON_IP&#125;</span></div><div class="line">auth cluster required = cephx</div><div class="line">auth service required = cephx</div><div class="line">auth client required = cephx</div><div class="line">osd crush chooseleaf <span class="built_in">type</span> = 0</div><div class="line">osd journal size = 100</div><div class="line">osd pool default pg num = 8</div><div class="line">osd pool default pgp num = 8</div><div class="line">osd pool default size = 1</div><div class="line">public network = <span class="variable">$&#123;CEPH_PUBLIC_NETWORK&#125;</span></div><div class="line">cluster network = <span class="variable">$&#123;CEPH_PUBLIC_NETWORK&#125;</span></div><div class="line">ENDHERE</div><div class="line"></div><div class="line">		<span class="comment"># For ext4</span></div><div class="line">		<span class="keyword">if</span> [ <span class="string">"<span class="variable">$(findmnt -n -o FSTYPE -T /var/lib/ceph)</span>"</span> = <span class="string">"ext4"</span> ]; <span class="keyword">then</span></div><div class="line">			cat &lt;&lt;ENDHERE &gt;&gt; /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.conf</div><div class="line">osd max object name len = 256</div><div class="line">osd max object namespace len = 64</div><div class="line">ENDHERE</div><div class="line">		<span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="comment"># Generate administrator key</span></div><div class="line">    ceph-authtool /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.client.admin.keyring --create-keyring --gen-key -n client.admin --set-uid=0 --cap mon <span class="string">'allow *'</span> --cap osd <span class="string">'allow *'</span> --cap mds <span class="string">'allow'</span></div><div class="line"></div><div class="line">    <span class="comment"># Generate the mon. key</span></div><div class="line">    ceph-authtool /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring --create-keyring --gen-key -n mon. --cap mon <span class="string">'allow *'</span></div><div class="line"></div><div class="line">    <span class="comment"># Generate initial monitor map</span></div><div class="line">    monmaptool --create --add <span class="variable">$&#123;MON_NAME&#125;</span> <span class="variable">$&#123;MON_IP&#125;</span> --fsid <span class="variable">$&#123;fsid&#125;</span> /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.monmap</div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="comment"># If we don't have a monitor keyring, this is a new monitor</span></div><div class="line">  <span class="keyword">if</span> [ ! <span class="_">-e</span> /var/lib/ceph/mon/<span class="variable">$&#123;CLUSTER&#125;</span>-<span class="variable">$&#123;MON_NAME&#125;</span>/keyring ]; <span class="keyword">then</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [ ! <span class="_">-e</span> /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.client.admin.keyring ]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"ERROR- /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.client.admin.keyring must exist; get it from your existing mon"</span></div><div class="line">      <span class="built_in">exit</span> 2</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [ ! <span class="_">-e</span> /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring ]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"ERROR- /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring must exist.  You can extract it from your current monitor by running 'ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> auth get mon. -o /tmp/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring'"</span></div><div class="line">      <span class="built_in">exit</span> 3</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> [ ! <span class="_">-e</span> /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.monmap ]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"ERROR- /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.monmap must exist.  You can extract it from your current monitor by running 'ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> mon getmap -o /tmp/monmap'"</span></div><div class="line">      <span class="built_in">exit</span> 4</div><div class="line">    <span class="keyword">fi</span></div><div class="line"></div><div class="line">    <span class="comment"># Import the client.admin keyring and the monitor keyring into a new, temporary one</span></div><div class="line">    ceph-authtool /tmp/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring --create-keyring --import-keyring /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.client.admin.keyring</div><div class="line">    ceph-authtool /tmp/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring --import-keyring /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring</div><div class="line"></div><div class="line">    <span class="comment"># Make the monitor directory</span></div><div class="line">    mkdir -p /var/lib/ceph/mon/<span class="variable">$&#123;CLUSTER&#125;</span>-<span class="variable">$&#123;MON_NAME&#125;</span></div><div class="line"></div><div class="line">    <span class="comment"># Make user 'ceph' the owner of all the tree</span></div><div class="line">    chown ceph. /var/lib/ceph/bootstrap-&#123;osd,mds,rgw&#125;</div><div class="line"></div><div class="line">    <span class="comment"># Prepare the monitor daemon's directory with the map and keyring</span></div><div class="line">    chown -R ceph. /var/lib/ceph/mon</div><div class="line">    ceph-mon <span class="variable">$&#123;CEPH_OPTS&#125;</span> --mkfs -i <span class="variable">$&#123;MON_NAME&#125;</span> --monmap /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.monmap --keyring /tmp/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring</div><div class="line">    ceph-mon <span class="variable">$&#123;CEPH_OPTS&#125;</span> --setuser ceph --setgroup ceph --mkfs -i <span class="variable">$&#123;MON_NAME&#125;</span> --monmap /etc/ceph/monmap --keyring /tmp/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring --mon-data /var/lib/ceph/mon/<span class="variable">$&#123;CLUSTER&#125;</span>-<span class="variable">$&#123;MON_NAME&#125;</span></div><div class="line"></div><div class="line">    <span class="comment"># Clean up the temporary key</span></div><div class="line">    rm /tmp/<span class="variable">$&#123;CLUSTER&#125;</span>.mon.keyring</div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="comment"># start MON</span></div><div class="line">  create_socket_dir</div><div class="line">  chown -R ceph. /var/lib/ceph/mon</div><div class="line">  ceph-mon <span class="variable">$&#123;CEPH_OPTS&#125;</span> -i <span class="variable">$&#123;MON_NAME&#125;</span> --public-addr <span class="string">"<span class="variable">$&#123;MON_IP&#125;</span>:6789"</span> --setuser ceph --setgroup ceph</div><div class="line"></div><div class="line">  <span class="comment"># change replica size</span></div><div class="line">  ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> osd pool <span class="built_in">set</span> rbd size 1</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#######</span></div><div class="line"><span class="comment"># OSD #</span></div><div class="line"><span class="comment">#######</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> bootstrap_osd &#123;</div><div class="line">  <span class="keyword">if</span> [ ! <span class="_">-e</span> /var/lib/ceph/osd/<span class="variable">$&#123;CLUSTER&#125;</span>-0/keyring ]; <span class="keyword">then</span></div><div class="line">    <span class="comment"># bootstrap OSD</span></div><div class="line">    mkdir -p /var/lib/ceph/osd/<span class="variable">$&#123;CLUSTER&#125;</span>-0</div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> osd create</div><div class="line">    chown -R ceph. /var/lib/ceph/osd/<span class="variable">$&#123;CLUSTER&#125;</span>-0</div><div class="line">    ceph-osd <span class="variable">$&#123;CEPH_OPTS&#125;</span> -i 0 --mkfs --setuser ceph --setgroup ceph</div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> auth get-or-create osd.0 osd <span class="string">'allow *'</span> mon <span class="string">'allow profile osd'</span> -o /var/lib/ceph/osd/<span class="variable">$&#123;CLUSTER&#125;</span>-0/keyring</div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> osd crush add 0 1 root=default host=localhost</div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="comment"># start OSD</span></div><div class="line">  chown -R ceph. /var/lib/ceph/osd/<span class="variable">$&#123;CLUSTER&#125;</span>-0</div><div class="line">  ceph-osd <span class="variable">$&#123;CEPH_OPTS&#125;</span> -i 0 --setuser ceph --setgroup ceph</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#######</span></div><div class="line"><span class="comment"># MDS #</span></div><div class="line"><span class="comment">#######</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> bootstrap_mds &#123;</div><div class="line">  <span class="keyword">if</span> [ ! <span class="_">-e</span> /var/lib/ceph/mds/<span class="variable">$&#123;CLUSTER&#125;</span>-0/keyring ]; <span class="keyword">then</span></div><div class="line">    <span class="comment"># create ceph filesystem</span></div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> osd pool create cephfs_data 8</div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> osd pool create cephfs_metadata 8</div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> fs new cephfs cephfs_metadata cephfs_data</div><div class="line"></div><div class="line">    <span class="comment"># bootstrap MDS</span></div><div class="line">    mkdir -p /var/lib/ceph/mds/<span class="variable">$&#123;CLUSTER&#125;</span>-0</div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> auth get-or-create mds.0 mds <span class="string">'allow'</span> osd <span class="string">'allow *'</span> mon <span class="string">'allow profile mds'</span> &gt; /var/lib/ceph/mds/<span class="variable">$&#123;CLUSTER&#125;</span>-0/keyring</div><div class="line">    chown -R ceph. /var/lib/ceph/mds/<span class="variable">$&#123;CLUSTER&#125;</span>-0</div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="comment"># start MDS</span></div><div class="line">  ceph-mds <span class="variable">$&#123;CEPH_OPTS&#125;</span> -i 0 --setuser ceph --setgroup ceph</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#######</span></div><div class="line"><span class="comment"># RGW #</span></div><div class="line"><span class="comment">#######</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> bootstrap_rgw &#123;</div><div class="line">  <span class="keyword">if</span> [ ! <span class="_">-e</span> /var/lib/ceph/radosgw/<span class="variable">$&#123;RGW_NAME&#125;</span>/keyring ]; <span class="keyword">then</span></div><div class="line">    <span class="comment"># bootstrap RGW</span></div><div class="line">    mkdir -p /var/lib/ceph/radosgw/<span class="variable">$&#123;RGW_NAME&#125;</span></div><div class="line">    ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> auth get-or-create client.radosgw.gateway osd <span class="string">'allow rwx'</span> mon <span class="string">'allow rw'</span> -o /var/lib/ceph/radosgw/<span class="variable">$&#123;RGW_NAME&#125;</span>/keyring</div><div class="line">    chown -R ceph. /var/lib/ceph/radosgw/<span class="variable">$&#123;RGW_NAME&#125;</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line">  <span class="comment"># start RGW</span></div><div class="line">  radosgw <span class="variable">$&#123;CEPH_OPTS&#125;</span> -c /etc/ceph/<span class="variable">$&#123;CLUSTER&#125;</span>.conf -n client.radosgw.gateway -k /var/lib/ceph/radosgw/<span class="variable">$&#123;RGW_NAME&#125;</span>/keyring --rgw-socket-path=<span class="string">""</span> --rgw-frontends=<span class="string">"civetweb port=<span class="variable">$&#123;RGW_CIVETWEB_PORT&#125;</span>"</span> --setuser ceph --setgroup ceph</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> bootstrap_demo_user &#123;</div><div class="line">  <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$CEPH_DEMO_UID</span>"</span> ] &amp;&amp; [ -n <span class="string">"<span class="variable">$CEPH_DEMO_ACCESS_KEY</span>"</span> ] &amp;&amp; [ -n <span class="string">"<span class="variable">$CEPH_DEMO_SECRET_KEY</span>"</span> ]; <span class="keyword">then</span></div><div class="line">    <span class="keyword">if</span> [ <span class="_">-f</span> /ceph-demo-user ]; <span class="keyword">then</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"Demo user already exists with credentials:"</span></div><div class="line">      cat /ceph-demo-user</div><div class="line">    <span class="keyword">else</span></div><div class="line">      <span class="built_in">echo</span> <span class="string">"Setting up a demo user..."</span></div><div class="line">      radosgw-admin user create --uid=<span class="variable">$CEPH_DEMO_UID</span> --display-name=<span class="string">"Ceph demo user"</span> --access-key=<span class="variable">$CEPH_DEMO_ACCESS_KEY</span> --secret-key=<span class="variable">$CEPH_DEMO_SECRET_KEY</span></div><div class="line">      sed -i s/AWS_ACCESS_KEY_PLACEHOLDER/<span class="variable">$CEPH_DEMO_ACCESS_KEY</span>/ /root/.s3cfg</div><div class="line">      sed -i s/AWS_SECRET_KEY_PLACEHOLDER/<span class="variable">$CEPH_DEMO_SECRET_KEY</span>/ /root/.s3cfg</div><div class="line">      <span class="built_in">echo</span> <span class="string">"Access key: <span class="variable">$CEPH_DEMO_ACCESS_KEY</span>"</span> &gt; /ceph-demo-user</div><div class="line">      <span class="built_in">echo</span> <span class="string">"Secret key: <span class="variable">$CEPH_DEMO_SECRET_KEY</span>"</span> &gt;&gt; /ceph-demo-user</div><div class="line"></div><div class="line">      <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$CEPH_DEMO_BUCKET</span>"</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"Creating bucket..."</span></div><div class="line">        s3cmd mb s3://<span class="variable">$CEPH_DEMO_BUCKET</span></div><div class="line">      <span class="keyword">fi</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#######</span></div><div class="line"><span class="comment"># NFS #</span></div><div class="line"><span class="comment">#######</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> bootstrap_nfs &#123;</div><div class="line">  <span class="comment"># Init RPC</span></div><div class="line">  rpcbind || <span class="built_in">return</span> 0</div><div class="line">  rpc.statd -L || <span class="built_in">return</span> 0</div><div class="line">  rpc.idmapd || <span class="built_in">return</span> 0</div><div class="line"></div><div class="line">  <span class="comment"># start ganesha</span></div><div class="line">  <span class="built_in">exec</span> /usr/bin/ganesha.nfsd -F <span class="variable">$&#123;GANESHA_OPTIONS&#125;</span> <span class="variable">$&#123;GANESHA_EPOCH&#125;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#######</span></div><div class="line"><span class="comment"># API #</span></div><div class="line"><span class="comment">#######</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> bootstrap_rest_api &#123;</div><div class="line">  <span class="comment"># start ceph-rest-api</span></div><div class="line">  ceph-rest-api <span class="variable">$&#123;CEPH_OPTS&#125;</span> -n client.admin &amp;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#########</span></div><div class="line"><span class="comment"># WATCH #</span></div><div class="line"><span class="comment">#########</span></div><div class="line"></div><div class="line">mkdir -p /var/lib/ceph/bootstrap-&#123;osd,mds,rgw&#125;</div><div class="line">bootstrap_mon</div><div class="line">bootstrap_osd</div><div class="line">bootstrap_mds</div><div class="line">bootstrap_rgw</div><div class="line">bootstrap_demo_user</div><div class="line">bootstrap_rest_api</div><div class="line">bootstrap_nfs</div><div class="line"></div><div class="line"><span class="built_in">exec</span> ceph <span class="variable">$&#123;CEPH_OPTS&#125;</span> -w</div></pre></td></tr></table></figure>
<h3 id="制作Docker-Image"><a href="#制作Docker-Image" class="headerlink" title="制作Docker Image"></a>制作Docker Image</h3><p>准备好<code>addkey, Dockerfile, entrypoint.sh</code>三个文件之后，制作<code>ceph</code>镜像如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">docker build -t=<span class="string">"ubuntu:ceph"</span> .</div></pre></td></tr></table></figure>
<h3 id="启动Ceph"><a href="#启动Ceph" class="headerlink" title="启动Ceph"></a>启动Ceph</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">docker run -idt -v /etc/ceph:/etc/ceph --name ceph ubuntu:ceph</div></pre></td></tr></table></figure>
<p>运行成功之后，在<code>Host</code>机器上运行：<code>ceph -s</code>可以得到如下结果：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">root@ceph-debug-9878:~/ceph.inst<span class="comment"># ceph -s</span></div><div class="line">    cluster 9a2720b9-3675-4a5f-9444-addbe1f7dd95</div><div class="line">     health HEALTH_OK</div><div class="line">     monmap e1: 1 mons at &#123;5672a24dd261=172.17.0.2:6789/0&#125;</div><div class="line">            election epoch 3, quorum 0 5672a24dd261</div><div class="line">      fsmap e5: 1/1/1 up &#123;0=0=up:active&#125;</div><div class="line">     osdmap e16: 1 osds: 1 up, 1 <span class="keyword">in</span></div><div class="line">            flags sortbitwise,require_jewel_osds</div><div class="line">      pgmap v39: 128 pgs, 9 pools, 3704 bytes data, 191 objects</div><div class="line">            13948 MB used, 183 GB / 196 GB avail</div><div class="line">                 128 active+clean</div></pre></td></tr></table></figure>
<h1 id="编译Ceph"><a href="#编译Ceph" class="headerlink" title="编译Ceph"></a>编译Ceph</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /var/lib/docker/ceph</div><div class="line">./autogen.sh</div><div class="line"></div><div class="line">screen -S compile.ceph</div><div class="line"><span class="built_in">export</span> CFLAGS=<span class="string">"-g3 -O0"</span>; ./configure  --enable-static --enable-debug</div><div class="line">make</div></pre></td></tr></table></figure>
<h2 id="出错处理"><a href="#出错处理" class="headerlink" title="出错处理"></a>出错处理</h2><p>在编译的时候，可能会出错，出错信息如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">  CXX      <span class="built_in">test</span>/librgw_file_cd-librgw_file_cd.o</div><div class="line">make[3]: *** No rule to make target `../src/gmock/lib/libgmock_main.la<span class="string">', needed by `librgw_file_cd'</span>.  Stop.</div><div class="line">make[3]: Leaving directory `/var/lib/docker/ceph/src<span class="string">'</span></div><div class="line">make[2]: *** [all-recursive] Error 1</div><div class="line">make[2]: Leaving directory `/var/lib/docker/ceph/src'</div><div class="line">make[1]: *** [all] Error 2</div><div class="line">make[1]: Leaving directory `/var/lib/docker/ceph/src<span class="string">'</span></div><div class="line">make: *** [all-recursive] Error 1</div></pre></td></tr></table></figure>
<p>处理办法如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ceph/src/gmock</div><div class="line"><span class="built_in">export</span> CFLAGS=<span class="string">"-g3 -O0"</span>; ./configure --enable-static</div><div class="line">make</div></pre></td></tr></table></figure>
<p>然后再回到<code>ceph/</code>目录下，运行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<h1 id="准备Qemu"><a href="#准备Qemu" class="headerlink" title="准备Qemu"></a>准备Qemu</h1><p>已经写好了一个包，可以很快地创建虚拟机。下载命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/JiYou/create.vm.git</div><div class="line">mv create.vm /cloud</div><div class="line"><span class="built_in">cd</span> /cloud</div><div class="line">./main</div></pre></td></tr></table></figure>
<h2 id="测试虚拟机"><a href="#测试虚拟机" class="headerlink" title="测试虚拟机"></a>测试虚拟机</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /cloud/</div><div class="line">./ubuntu-ceph h1</div></pre></td></tr></table></figure>
<p>如果看到如下输出，那么证明安装成功： </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">.....</div><div class="line">+ sed -i s,%HOST_NAME%,h1,g /tmp/tmp.gcHNgxmKzO/etc/hosts</div><div class="line">+ <span class="built_in">echo</span> h1</div><div class="line">+ virsh define h1/h1</div><div class="line">Domain h1 defined from h1/h1</div><div class="line"></div><div class="line">+ virsh start h1</div><div class="line">Domain h1 started</div></pre></td></tr></table></figure>
<h2 id="关闭虚拟机"><a href="#关闭虚拟机" class="headerlink" title="关闭虚拟机"></a>关闭虚拟机</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">virsh destroy h1</div><div class="line">virsh undefine h1</div></pre></td></tr></table></figure>
<h1 id="安装gdb"><a href="#安装gdb" class="headerlink" title="安装gdb"></a>安装gdb</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y gdb</div></pre></td></tr></table></figure>
<h1 id="编译Qemu"><a href="#编译Qemu" class="headerlink" title="编译Qemu"></a>编译Qemu</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y device-tree-compiler texinfo libasound2-dev libattr1-dev libbluetooth-dev libbrlapi-dev libcap-dev libcap-ng-dev libfdt-dev libncurses5-dev libpixman-1-dev libpulse-dev librados-dev librbd-dev libsasl2-dev libsdl1.2-dev libseccomp-dev libspice-server-dev libspice-protocol-dev libusb-1.0-0-dev libusbredirparser-dev libx11-dev libxen-dev libpng12-dev</div><div class="line">./configure --prefix=/usr --enable-debug --enable-rbd</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：这里一定要把<code>--prefix=/usr --enable-debug --enable-rbd</code>加上，不能少了<code>--prefix=/usr</code>这一段。否则容易出现不能<code>debug</code>的情况。</p>
<h2 id="出错处理-1"><a href="#出错处理-1" class="headerlink" title="出错处理"></a>出错处理</h2><p>在执行<code>make install</code>的时候，很有可能会遇到下面这个错误。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">install: cannot <span class="built_in">stat</span> ‘/var/lib/docker/qemu-2.0.0+dfsg/pc-bios/bios.bin’: No such file or directory</div><div class="line">make: *** [install] Error 1</div></pre></td></tr></table></figure>
<p>解决办法：</p>
<p>注释掉<code>Makefile</code>里面的这一段：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">387 <span class="comment">#ifneq ($(BLOBS),)</span></div><div class="line">388 <span class="comment">#       set -e; for x in $(BLOBS); do \</span></div><div class="line">389 <span class="comment">#               $(INSTALL_DATA) $(SRC_PATH)/pc-bios/$$x "$(DESTDIR)$(qemu_datadir)"; \</span></div><div class="line">390 <span class="comment">#       done</span></div><div class="line">391 <span class="comment">#endif</span></div></pre></td></tr></table></figure>
<p>修改完成之后，再运行<code>make install</code>。</p>
<h1 id="测试GDB"><a href="#测试GDB" class="headerlink" title="测试GDB"></a>测试GDB</h1><p>在测试<code>gdb</code>之前，先尝试是否可以启动<code>vm</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">/usr/bin/qemu-system-x86_64 -name h1 -m 126 -drive file=/cloud/h1/ubuntu-h1.qcow2,<span class="keyword">if</span>=none,id=drive-virtio-disk0,format=qcow2 -vnc 0.0.0.0:0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x6,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1</div></pre></td></tr></table></figure>
<p>启动成功之后，尝试使用<code>vncviewer</code>进行连接。如果虚拟机里面没有启动过别的机器。那么直接可以使用<code>IP:0</code>来访问这个虚拟机里面的虚拟机。</p>
<h1 id="准备Ceph-Rbd-Image"><a href="#准备Ceph-Rbd-Image" class="headerlink" title="准备Ceph Rbd Image"></a>准备Ceph Rbd Image</h1><p>为了简单起见，这里直接使用<code>ceph</code>里面的<code>admin</code>用户来测试。在<code>host</code>机器上准备如下文件<code>secret.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">secret</span> <span class="attr">ephemeral</span>=<span class="string">'no'</span> <span class="attr">private</span>=<span class="string">'no'</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>5a3d9df2-3d31-4fca-bd9b-8451843a9c0e<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">usage</span> <span class="attr">type</span>=<span class="string">'ceph'</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">name</span>&gt;</span>client.admin secret<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">usage</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">secret</span>&gt;</span></div></pre></td></tr></table></figure>
<p>运行命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">virsh secret-define secret.xml</div></pre></td></tr></table></figure>
<h2 id="设置密码"><a href="#设置密码" class="headerlink" title="设置密码"></a>设置密码</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ceph auth list</div></pre></td></tr></table></figure>
<p>得到输出如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">client.admin</div><div class="line">	key: AQC0AO5XWb3VIRAAruUnyz0D8vxrMCnU/zERRQ==</div><div class="line">	auid: 0</div><div class="line">	caps: [mds] allow</div><div class="line">	caps: [mon] allow *</div><div class="line">	caps: [osd] allow *</div></pre></td></tr></table></figure>
<p>设置密码命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">virsh secret-set-value --secret 5a3d9df2-3d31-4fca-bd9b-8451843a9c0e --base64 <span class="string">"AQC0AO5XWb3VIRAAruUnyz0D8vxrMCnU/zERRQ=="</span></div></pre></td></tr></table></figure>
<p>注意：<code>uuid</code>与<code>key</code>的对应。</p>
<h2 id="创建rbd-image"><a href="#创建rbd-image" class="headerlink" title="创建rbd image"></a>创建rbd image</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">rbd create rbd/new-libvirt-image --size 100</div></pre></td></tr></table></figure>
<p>这里申请<code>1G</code>的空间。然后在<code>/cloud/h1/h1</code>文件里面添加对于这个<code>rbd image</code>的引用。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">devices</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'file'</span> <span class="attr">device</span>=<span class="string">'disk'</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">'qemu'</span> <span class="attr">type</span>=<span class="string">'qcow2'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">'/cloud/h1/ubuntu-h1.qcow2'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'vda'</span> <span class="attr">bus</span>=<span class="string">'virtio'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">'virtio-disk0'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">'pci'</span> <span class="attr">domain</span>=<span class="string">'0x0000'</span> <span class="attr">bus</span>=<span class="string">'0x00'</span> <span class="attr">slot</span>=<span class="string">'0x06'</span> <span class="attr">function</span>=<span class="string">'0x0'</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 下面是我新加的 --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'network'</span> <span class="attr">device</span>=<span class="string">'disk'</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">'qemu'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">'admin'</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">secret</span> <span class="attr">type</span>=<span class="string">'ceph'</span> <span class="attr">uuid</span>=<span class="string">'5a3d9df2-3d31-4fca-bd9b-8451843a9c0e'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">auth</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">source</span> <span class="attr">protocol</span>=<span class="string">'rbd'</span> <span class="attr">name</span>=<span class="string">'rbd/new-libvirt-image'</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">'172.17.0.2'</span> <span class="attr">port</span>=<span class="string">'6789'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">source</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'vdb'</span> <span class="attr">bus</span>=<span class="string">'virtio'</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">'pci'</span> <span class="attr">domain</span>=<span class="string">'0x0000'</span> <span class="attr">bus</span>=<span class="string">'0x00'</span> <span class="attr">slot</span>=<span class="string">'0x03'</span> <span class="attr">function</span>=<span class="string">'0x0'</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="重新定义虚拟机"><a href="#重新定义虚拟机" class="headerlink" title="重新定义虚拟机"></a>重新定义虚拟机</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">virsh destroy h1</div><div class="line">virsh define /cloud/h1/h1</div><div class="line">virsh start h1</div></pre></td></tr></table></figure>
<p>然后再尝试使用<code>vncviewer</code>查看虚拟机。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">gdb --dir=/var/lib/docker/ceph -tui --args /usr/bin/qemu-system-x86_64 -name h1 -m 126 -drive file=/cloud/h1/ubuntu-h1.qcow2,<span class="keyword">if</span>=none,id=drive-virtio-disk0,format=qcow2 -vnc 0.0.0.0:0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x6,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -drive <span class="string">"file=rbd:rbd/new-libvirt-image:id=admin:key=AQC0AO5XWb3VIRAAruUnyz0D8vxrMCnU/zERRQ==:auth_supported=cephx\;none:mon_host=172.17.0.2\:6789,if=none,id=drive-virtio-disk1"</span> -device <span class="string">"virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk1,id=virtio-disk1"</span></div></pre></td></tr></table></figure>
<p>注意：这里要把<code>--dir=/var/lib/docker/ceph</code>改成编译ceph的具体位置。否则<code>gdb</code>的时候容易找不到源码。</p>
<h2 id="简单的debug步骤"><a href="#简单的debug步骤" class="headerlink" title="简单的debug步骤"></a>简单的debug步骤</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">1. <span class="built_in">break</span> main // &lt;- 让代码进入main函数停住</div><div class="line">2. <span class="built_in">break</span> rbd.c:621 // &lt;- 代码进入rbd.c代码逻辑的时候，停住。</div><div class="line">3. start // &lt;- 让程序开始执行</div><div class="line">4. c // &lt;-- 表示继续执行，直到下一个断点。</div><div class="line">5. n // &lt;-- 表示下一步</div><div class="line">6. s // &lt;-- 表示进入子函数代码</div><div class="line">7. <span class="built_in">print</span> a // &lt;-- 表示打印a变量。</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ceph/">ceph</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/gdb/">gdb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/qemu/">qemu</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/blog/categories/ceph/">ceph</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-ceph-debug" data-title="Qemu RBD调试Ceph" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-getport" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/23/getport/" class="article-date">
  	<time datetime="2016-09-23T05:57:02.000Z" itemprop="datePublished">2016-09-23</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<style type="text/css">
*{margin:0;padding:0;}
body {
	font:13.34px helvetica,arial,freesans,clean,sans-serif;
	color:black;
	line-height:1.4em;
	background-color: #F8F8F8;
	padding: 0.7em;
}
p {
	margin:1em 0;
	line-height:1.5em;
}
table {
	font-size:inherit;
	font:100%;
	margin:1em;
}
table th{border-bottom:1px solid #bbb;padding:.2em 1em;}
table td{border-bottom:1px solid #ddd;padding:.2em 1em;}
input[type=text],input[type=password],input[type=image],textarea{font:99% helvetica,arial,freesans,sans-serif;}
select,option{padding:0 .25em;}
optgroup{margin-top:.5em;}
pre,code{font:12px Monaco,"Courier New","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;}
pre {
	margin:1em 0;
	font-size:12px;
	background-color:#eee;
	border:1px solid #ddd;
	padding:5px;
	line-height:1.5em;
	color:#444;
	overflow:auto;
	-webkit-box-shadow:rgba(0,0,0,0.07) 0 1px 2px inset;
	-webkit-border-radius:3px;
	-moz-border-radius:3px;border-radius:3px;
}
pre code {
	padding:0;
	font-size:12px;
	background-color:#eee;
	border:none;
}
code {
	font-size:12px;
	background-color:#f8f8ff;
	color:#444;
	padding:0 .2em;
	border:1px solid #dedede;
}
img{border:0;max-width:100%;}
abbr{border-bottom:none;}
a{color:#4183c4;text-decoration:none;}
a:hover{text-decoration:underline;}
a code,a:link code,a:visited code{color:#4183c4;}
h2,h3{margin:1em 0;}
h1,h2,h3,h4,h5,h6{border:0;}
h1{font-size:170%;border-top:4px solid #aaa;padding-top:.5em;margin-top:1.5em;}
h1:first-child{margin-top:0;padding-top:.25em;border-top:none;}
h2{font-size:150%;margin-top:1.5em;border-top:4px solid #e0e0e0;padding-top:.5em;}
h3{margin-top:1em;}
hr{border:1px solid #ddd;}
ul{margin:1em 0 1em 2em;}
ol{margin:1em 0 1em 2em;}
ul li,ol li{margin-top:.5em;margin-bottom:.5em;}
ul ul,ul ol,ol ol,ol ul{margin-top:0;margin-bottom:0;}
blockquote{margin:1em 0;border-left:5px solid #ddd;padding-left:.6em;color:#555;}
dt{font-weight:bold;margin-left:1em;}
dd{margin-left:2em;margin-bottom:1em;}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
<style type="text/css">
pre[class*=language-]{position:relative}pre[class*=language-][data-language]::before{content:attr(data-language);color:#000;background-color:#CFCFCF;display:inline-block;position:absolute;top:0;right:0;font-size:.9em;border-radius:0 0 0 5px;padding:0 .5em;text-shadow:none}
</style>
</head>
<body>
<h1 id="toc_0">位于~/.bashrc中</h1>

<pre><code class="language-none"># 获取port的ID
function getport() {
    ovs-vsctl get interface $1 ofport
}
# 获取interface的mac地址。
function getmac() {
    ovs-vsctl get interface $1 external_ids | awk -F &quot;=&quot; &#39;{print $2}&#39; | awk -F &quot;\&quot;&quot; &#39;{print $2}&#39;
}</code></pre>

<script type="text/javascript">
var _self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{},Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=_self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.map&&e.map(function(e){return t.util.clone(e)})}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var i=r[e];if(2==arguments.length){a=arguments[1];for(var l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);return i}var o={};for(var s in i)if(i.hasOwnProperty(s)){if(s==n)for(var l in a)a.hasOwnProperty(l)&&(o[l]=a[l]);o[s]=i[s]}return t.languages.DFS(t.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=o)}),r[e]=o},DFS:function(e,n,a){for(var r in e)e.hasOwnProperty(r)&&(n.call(e,r,e[r],a||r),"Object"===t.util.type(e[r])?t.languages.DFS(e[r],n):"Array"===t.util.type(e[r])&&t.languages.DFS(e[r],n,r))}},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;a=r[i++];)t.highlightElement(a,e===!0,n)},highlightElement:function(a,r,i){for(var l,o,s=a;s&&!e.test(s.className);)s=s.parentNode;s&&(l=(s.className.match(e)||[,""])[1],o=t.languages[l]),a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,s=a.parentNode,/pre/i.test(s.nodeName)&&(s.className=s.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var u=a.textContent,c={element:a,language:l,grammar:o,code:u};if(u&&(c.code=u.replace(/^(?:\r?\n|\r)/,"")),!u||!o)return t.hooks.run("complete",c),void 0;if(t.hooks.run("before-highlight",c),r&&_self.Worker){var g=new Worker(t.filename);g.onmessage=function(e){c.highlightedCode=n.stringify(JSON.parse(e.data),l),t.hooks.run("before-insert",c),c.element.innerHTML=c.highlightedCode,i&&i.call(c.element),t.hooks.run("after-highlight",c),t.hooks.run("complete",c)},g.postMessage(JSON.stringify({language:c.language,code:c.code}))}else c.highlightedCode=t.highlight(c.code,c.grammar,c.language),t.hooks.run("before-insert",c),c.element.innerHTML=c.highlightedCode,i&&i.call(a),t.hooks.run("after-highlight",c),t.hooks.run("complete",c)},highlight:function(e,a,r){var i=t.tokenize(e,a);return n.stringify(t.util.encode(i),r)},tokenize:function(e,n){var a=t.Token,r=[e],i=n.rest;if(i){for(var l in i)n[l]=i[l];delete n.rest}e:for(var l in n)if(n.hasOwnProperty(l)&&n[l]){var o=n[l];o="Array"===t.util.type(o)?o:[o];for(var s=0;s<o.length;++s){var u=o[s],c=u.inside,g=!!u.lookbehind,f=0,h=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){u.lastIndex=0;var m=u.exec(d);if(m){g&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),N=[p,1];b&&N.push(b);var O=new a(l,c?t.tokenize(m,c):m,h);N.push(O),w&&N.push(w),Array.prototype.splice.apply(r,N)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,i=0;r=a[i++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("Array"===t.util.type(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var i={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==i.type&&(i.attributes.spellcheck="true"),e.alias){var l="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(i.classes,l)}t.hooks.run("wrap",i);var o="";for(var s in i.attributes)o+=s+'="'+(i.attributes[s]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+o+">"+i.content+"</"+i.tag+">"},!_self.document)return _self.addEventListener?(_self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code;_self.postMessage(JSON.stringify(t.util.encode(t.tokenize(r,t.languages[a])))),_self.close()},!1),_self.Prism):_self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),_self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism);
</script>
<script type="text/javascript">
!function(){if(self.Prism){var e={csharp:"C#",cpp:"C++"};Prism.hooks.add("before-highlight",function(a){var t=a.element.parentNode;if(t&&/pre/i.test(t.nodeName)){var i=e[a.language]||a.language;t.setAttribute("data-language",i)}})}}();
</script>
</body>

</html>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-getport" data-title="" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-install-openstack" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/20/install-openstack/" class="article-date">
  	<time datetime="2016-09-20T14:03:45.000Z" itemprop="datePublished">2016-09-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/20/install-openstack/">install.openstack</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="安装OpenStack包"><a href="#安装OpenStack包" class="headerlink" title="安装OpenStack包"></a>安装OpenStack包</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get -y update</div><div class="line">apt-get install -y software-properties-common</div><div class="line">add-apt-repository -y cloud-archive:mitaka</div><div class="line">apt-get -y update &amp;&amp; apt-get -y dist-upgrade</div><div class="line">apt-get install -y python-openstackclient crudini</div><div class="line"></div><div class="line">sed -i <span class="string">"/sleep/d"</span> /etc/init/failsafe.conf</div></pre></td></tr></table></figure>
<h1 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y mariadb-server python-pymysql</div></pre></td></tr></table></figure>
<p><strong>设置密码为: mysqlpassword</strong></p>
<p>修改配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cp -rf /etc/mysql/my.cnf /etc/mysql/my.cnf.bak</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/etc/mysql/my.cnf</div><div class="line">[client]</div><div class="line">port		= 3306</div><div class="line">socket		= /var/run/mysqld/mysqld.sock</div><div class="line">[mysqld_safe]</div><div class="line">socket		= /var/run/mysqld/mysqld.sock</div><div class="line">nice		= 0</div><div class="line">[mysqld]</div><div class="line">user		= mysql</div><div class="line">pid-file	= /var/run/mysqld/mysqld.pid</div><div class="line">socket		= /var/run/mysqld/mysqld.sock</div><div class="line">port		= 3306</div><div class="line">basedir		= /usr</div><div class="line">datadir		= /var/lib/mysql</div><div class="line">tmpdir		= /tmp</div><div class="line">lc-messages-dir	= /usr/share/mysql</div><div class="line">skip-external-locking</div><div class="line"><span class="built_in">bind</span>-address		= 0.0.0.0</div><div class="line">key_buffer		= 16M</div><div class="line">max_allowed_packet	= 16M</div><div class="line">thread_stack		= 192K</div><div class="line">thread_cache_size       = 8</div><div class="line">myisam-recover         = BACKUP</div><div class="line">query_cache_limit	= 1M</div><div class="line">query_cache_size        = 16M</div><div class="line">log_error = /var/<span class="built_in">log</span>/mysql/error.log</div><div class="line">expire_logs_days	= 10</div><div class="line">max_binlog_size         = 100M</div><div class="line">default-storage-engine = innodb</div><div class="line">innodb_file_per_table = 1</div><div class="line">max_connections = 4096</div><div class="line">collation-server = utf8_general_ci</div><div class="line">character-set-server = utf8</div><div class="line">[mysqldump]</div><div class="line">quick</div><div class="line">quote-names</div><div class="line">max_allowed_packet	= 16M</div><div class="line">[mysql]</div><div class="line">[isamchk]</div><div class="line">key_buffer		= 16M</div><div class="line">!includedir /etc/mysql/conf.d/</div><div class="line">EOF</div><div class="line"></div><div class="line">service mysql restart</div></pre></td></tr></table></figure>
<h1 id="安装RabbitMQ"><a href="#安装RabbitMQ" class="headerlink" title="安装RabbitMQ"></a>安装RabbitMQ</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y rabbitmq-server</div><div class="line">rabbitmqctl add_user openstack RABBIT_PASS</div><div class="line">rabbitmqctl set_permissions openstack <span class="string">".*"</span> <span class="string">".*"</span> <span class="string">".*"</span></div></pre></td></tr></table></figure>
<h1 id="Memcached"><a href="#Memcached" class="headerlink" title="Memcached"></a>Memcached</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y memcached python-memcache</div><div class="line">sed -i <span class="string">"s,-l 127.0.0.1,-l 0.0.0.0,g"</span> /etc/memcached.conf</div><div class="line">service memcached restart</div></pre></td></tr></table></figure>
<h1 id="安装Keystone"><a href="#安装Keystone" class="headerlink" title="安装Keystone"></a>安装Keystone</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y keystone apache2 libapache2-mod-wsgi</div><div class="line"></div><div class="line">cat &lt;<span class="string">"EOF"</span>&gt;keystone.sql</div><div class="line">CREATE DATABASE keystone;</div><div class="line">GRANT ALL PRIVILEGES ON keystone.* TO <span class="string">'keystone'</span>@<span class="string">'localhost'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'KEYSTONE_DBPASS'</span>;</div><div class="line">GRANT ALL PRIVILEGES ON keystone.* TO <span class="string">'keystone'</span>@<span class="string">'%'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'KEYSTONE_DBPASS'</span>;</div><div class="line">EOF</div><div class="line"></div><div class="line">mysql -uroot -pmysqlpassword &lt; keystone.sql</div></pre></td></tr></table></figure>
<p>修改配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">crudini --set /etc/keystone/keystone.conf DEFAULT admin_token ADMIN_TOKEN</div><div class="line">crudini --set /etc/keystone/keystone.conf database connection mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone</div><div class="line">crudini --set /etc/keystone/keystone.conf token provider fernet</div><div class="line">crudini --set /etc/keystone/keystone.conf eventlet_server public_workers 1</div><div class="line">crudini --set /etc/keystone/keystone.conf eventlet_server admin_workers 1</div><div class="line">rm <span class="_">-f</span> /var/lib/keystone/keystone.db</div></pre></td></tr></table></figure>
<p>初始化数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">su <span class="_">-s</span> /bin/sh -c <span class="string">"keystone-manage db_sync"</span> keystone</div></pre></td></tr></table></figure>
<p>初始化Fernet keys：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone</div><div class="line">service keystone restart</div></pre></td></tr></table></figure>
<h1 id="初始化Keystone"><a href="#初始化Keystone" class="headerlink" title="初始化Keystone"></a>初始化Keystone</h1><p>编写文件<code>init-keystone.sh</code>如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="comment"># Must link keystone host.</span></div><div class="line"><span class="comment">#---------------------------------------------------------------------------------------</span></div><div class="line"><span class="comment"># Init Keystone Host</span></div><div class="line"><span class="comment">#---------------------------------------------------------------------------------------</span></div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/rootrc</div><div class="line"><span class="built_in">export</span> OS_TOKEN=ADMIN_TOKEN</div><div class="line"><span class="built_in">export</span> OS_URL=http://controller:35357/v3</div><div class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</div><div class="line">EOF</div><div class="line"></div><div class="line"><span class="built_in">source</span> /rootrc</div><div class="line"></div><div class="line"><span class="comment"># register keystone</span></div><div class="line"><span class="keyword">if</span> [[ `openstack service list | grep keystone | wc <span class="_">-l</span>` <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    openstack service create --name keystone --description <span class="string">"OpenStack Identity"</span> identity</div><div class="line">    openstack endpoint create --region RegionOne identity public http://controller:5000/v3</div><div class="line">    openstack endpoint create --region RegionOne identity internal http://controller:5000/v3</div><div class="line">    openstack endpoint create --region RegionOne identity admin http://controller:35357/v3</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># Create domain</span></div><div class="line"><span class="keyword">if</span> [[ `openstack domain list| grep default | wc <span class="_">-l</span>` <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    openstack domain create --description <span class="string">"Default Domain"</span> default</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># create admin project</span></div><div class="line"><span class="keyword">if</span> [[ `openstack project list | grep admin | wc <span class="_">-l</span>` <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    openstack project create --domain default --description <span class="string">"Admin Project"</span> admin</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># create amdin user</span></div><div class="line"><span class="keyword">if</span> [[ `openstack user list | grep admin | wc <span class="_">-l</span>` <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    openstack user create --domain default --password admin admin</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># create admin role</span></div><div class="line"><span class="keyword">if</span> [[ `openstack role list | grep admin | wc <span class="_">-l</span>` <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    openstack role create admin</div><div class="line">    openstack role add --project admin --user admin admin</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># Create service tenant</span></div><div class="line"><span class="keyword">if</span> [[ `openstack project list | grep service | wc <span class="_">-l</span>` <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    openstack project create --domain default --description <span class="string">"Service Project"</span> service</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># Create demo user</span></div><div class="line"><span class="keyword">if</span> [[ `openstack project list | grep demo | wc <span class="_">-l</span>` <span class="_">-eq</span> 0 ]]; <span class="keyword">then</span></div><div class="line">    openstack project create --domain default --description <span class="string">"Demo Project"</span> demo</div><div class="line">    openstack user create --domain default --password demo demo</div><div class="line">    openstack role create user</div><div class="line">    openstack role add --project demo --user demo user</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># verify keystone</span></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/adminrc</div><div class="line"><span class="built_in">unset</span> OS_TOKEN</div><div class="line"><span class="built_in">unset</span> OS_URL</div><div class="line"><span class="built_in">unset</span> OS_IDENTITY_API_VERSION</div><div class="line"></div><div class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_NAME=default</div><div class="line"><span class="built_in">export</span> OS_USER_DOMAIN_NAME=default</div><div class="line"><span class="built_in">export</span> OS_PROJECT_NAME=admin</div><div class="line"><span class="built_in">export</span> OS_USERNAME=admin</div><div class="line"><span class="built_in">export</span> OS_PASSWORD=admin</div><div class="line"><span class="built_in">export</span> OS_AUTH_URL=http://controller:35357/v3</div><div class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</div><div class="line"><span class="built_in">export</span> OS_IMAGE_API_VERSION=2</div><div class="line"><span class="built_in">export</span> PS1=<span class="string">"adminrc\u@\h:\w\$ "</span></div><div class="line">EOF</div><div class="line"></div><div class="line"><span class="built_in">source</span> /adminrc</div><div class="line">openstack token issue</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/demorc</div><div class="line"><span class="built_in">unset</span> OS_TOKEN</div><div class="line"><span class="built_in">unset</span> OS_URL</div><div class="line"><span class="built_in">unset</span> OS_IDENTITY_API_VERSION</div><div class="line"></div><div class="line"><span class="built_in">export</span> OS_PROJECT_DOMAIN_NAME=default</div><div class="line"><span class="built_in">export</span> OS_USER_DOMAIN_NAME=default</div><div class="line"><span class="built_in">export</span> OS_PROJECT_NAME=demo</div><div class="line"><span class="built_in">export</span> OS_USERNAME=demo</div><div class="line"><span class="built_in">export</span> OS_PASSWORD=demo</div><div class="line"><span class="built_in">export</span> OS_AUTH_URL=http://controller:5000/v3</div><div class="line"><span class="built_in">export</span> OS_IDENTITY_API_VERSION=3</div><div class="line"><span class="built_in">export</span> OS_IMAGE_API_VERSION=2</div><div class="line"><span class="built_in">export</span> PS1=<span class="string">"demorc\u@\h:\w\$ "</span></div><div class="line">EOF</div><div class="line"></div><div class="line">openstack token issue</div></pre></td></tr></table></figure>
<p>然后运行:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">chmod +x init-keystone.sh</div><div class="line">./init-keystone.sh</div></pre></td></tr></table></figure>
<h1 id="安装Swift"><a href="#安装Swift" class="headerlink" title="安装Swift"></a>安装Swift</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">source /adminrc</div><div class="line">if [[ `openstack user list | grep swift | wc -l` -eq 0 ]]; then</div><div class="line">    openstack user create --domain default --password swift swift</div><div class="line">    openstack role add --project service --user swift admin</div><div class="line">    openstack service create --name swift --description &quot;OpenStack Object Storage&quot; object-store</div><div class="line">    openstack endpoint create --region RegionOne object-store public http://controller:8080/v1/AUTH_%\(tenant_id\)s</div><div class="line">    openstack endpoint create --region RegionOne object-store internal http://controller:8080/v1/AUTH_%\(tenant_id\)s</div><div class="line">    openstack endpoint create --region RegionOne object-store admin http://controller:8080/v1</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>然后运行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">chmod +x init-swift.sh</div><div class="line">./init-swift.sh</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y swift swift-proxy python-swiftclient \</div><div class="line">  python-keystoneclient python-keystonemiddleware \</div><div class="line">  memcached</div><div class="line"></div><div class="line">  </div><div class="line">mkdir -p /etc/swift</div><div class="line">curl -o /etc/swift/proxy-server.conf https://git.openstack.org/cgit/openstack/swift/plain/etc/proxy-server.conf-sample?h=stable/mitaka</div><div class="line">crudini --set /etc/swift/proxy-server.conf DEFAULT bind_port 8080</div><div class="line">crudini --set /etc/swift/proxy-server.conf DEFAULT user swift</div><div class="line">crudini --set /etc/swift/proxy-server.conf DEFAULT swift_dir /etc/swift</div><div class="line">crudini --set /etc/swift/proxy-server.conf pipeline:main pipeline <span class="string">"catch_errors gatekeeper healthcheck proxy-logging cache container_sync bulk ratelimit authtoken keystoneauth container-quotas account-quotas slo dlo versioned_writes proxy-logging proxy-server"</span></div><div class="line">crudini --set /etc/swift/proxy-server.conf app:proxy-server use egg:swift<span class="comment">#proxy</span></div><div class="line">crudini --set /etc/swift/proxy-server.conf app:proxy-server account_autocreate True</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:keystoneauth use egg:swift<span class="comment">#keystoneauth</span></div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:keystoneauth operator_roles admin,user</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken paste.filter_factory keystonemiddleware.auth_token:filter_factory</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken auth_uri http://controller:5000</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken auth_url http://controller:35357</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken memcached_servers controller:11211</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken auth_type password</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken project_domain_name default</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken user_domain_name default</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken project_name service</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken username swift</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken password swift</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:authtoken delay_auth_decision True</div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:cache use egg:swift<span class="comment">#memcache</span></div><div class="line">crudini --set /etc/swift/proxy-server.conf filter:cache memcache_servers controller:11211</div></pre></td></tr></table></figure>
<p>安装存储服务:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y swift swift-account swift-container swift-object</div><div class="line">curl -o /etc/swift/account-server.conf https://git.openstack.org/cgit/openstack/swift/plain/etc/account-server.conf-sample?h=stable/mitaka</div><div class="line">curl -o /etc/swift/container-server.conf https://git.openstack.org/cgit/openstack/swift/plain/etc/container-server.conf-sample?h=stable/mitaka</div><div class="line">curl -o /etc/swift/object-server.conf https://git.openstack.org/cgit/openstack/swift/plain/etc/object-server.conf-sample?h=stable/mitaka</div></pre></td></tr></table></figure>
<p>安装account服务：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">crudini --set /etc/swift/account-server.conf DEFAULT bind_ip 192.168.211.128</div><div class="line">crudini --set /etc/swift/account-server.conf DEFAULT bind_port 6002</div><div class="line">crudini --set /etc/swift/account-server.conf DEFAULT user swift</div><div class="line">crudini --set /etc/swift/account-server.conf DEFAULT swift_dir /etc/swift</div><div class="line">crudini --set /etc/swift/account-server.conf DEFAULT devices /srv/node</div><div class="line">crudini --set /etc/swift/account-server.conf DEFAULT mount_check True</div><div class="line">crudini --set /etc/swift/account-server.conf pipeline:main pipeline <span class="string">"healthcheck recon account-server"</span></div><div class="line">crudini --set /etc/swift/account-server.conf filter:recon use egg:swift<span class="comment">#recon</span></div><div class="line">crudini --set /etc/swift/account-server.conf filter:recon recon_cache_path /var/cache/swift</div></pre></td></tr></table></figure>
<p>配置container部分</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">crudini --set /etc/swift/container-server.conf DEFAULT bind_ip 192.168.211.128</div><div class="line">crudini --set /etc/swift/container-server.conf DEFAULT bind_port 6001</div><div class="line">crudini --set /etc/swift/container-server.conf DEFAULT user swift</div><div class="line">crudini --set /etc/swift/container-server.conf DEFAULT swift_dir /etc/swift</div><div class="line">crudini --set /etc/swift/container-server.conf DEFAULT devices /srv/node</div><div class="line">crudini --set /etc/swift/container-server.conf DEFAULT mount_check True</div><div class="line">crudini --set /etc/swift/container-server.conf pipeline:main pipeline <span class="string">"healthcheck recon container-server"</span></div><div class="line">crudini --set /etc/swift/container-server.conf filter:recon use egg:swift<span class="comment">#recon</span></div><div class="line">crudini --set /etc/swift/container-server.conf filter:recon recon_cache_path /var/cache/swift</div></pre></td></tr></table></figure>
<p>配置Object部分</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">crudini --set /etc/swift/object-server.conf DEFAULT bind_ip 192.168.211.128</div><div class="line">crudini --set /etc/swift/object-server.conf DEFAULT bind_port 6000</div><div class="line">crudini --set /etc/swift/object-server.conf DEFAULT user swift</div><div class="line">crudini --set /etc/swift/object-server.conf DEFAULT swift_dir /etc/swift</div><div class="line">crudini --set /etc/swift/object-server.conf DEFAULT devices /srv/node</div><div class="line">crudini --set /etc/swift/object-server.conf DEFAULT mount_check True</div><div class="line">crudini --set /etc/swift/object-server.conf pipeline:main pipeline <span class="string">"healthcheck recon object-server"</span></div><div class="line">crudini --set /etc/swift/object-server.conf filter:recon use egg:swift<span class="comment">#recon</span></div><div class="line">crudini --set /etc/swift/object-server.conf filter:recon recon_cache_path /var/cache/swift</div><div class="line">crudini --set /etc/swift/object-server.conf filter:recon recon_lock_path /var/lock</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mkdir -p /srv/node</div><div class="line">chown -R swift:swift /srv/node</div><div class="line">mkdir -p /var/cache/swift</div><div class="line">chown -R root:swift /var/cache/swift</div><div class="line">chmod -R 775 /var/cache/swift</div></pre></td></tr></table></figure>
<p>生成存储目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y xfsprogs rsync tree</div><div class="line">mkdir -p /srv/node/sda</div><div class="line">mkdir -p /srv/node/sdb</div><div class="line">mkdir -p /srv/node/sdc</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/etc/rsyncd.conf</div><div class="line">uid = swift</div><div class="line">gid = swift</div><div class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log</div><div class="line">pid file = /var/run/rsyncd.pid</div><div class="line">address = 192.168.211.128</div><div class="line"></div><div class="line">[account]</div><div class="line">max connections = 2</div><div class="line">path = /srv/node/</div><div class="line"><span class="built_in">read</span> only = False</div><div class="line">lock file = /var/lock/account.lock</div><div class="line"></div><div class="line">[container]</div><div class="line">max connections = 2</div><div class="line">path = /srv/node/</div><div class="line"><span class="built_in">read</span> only = False</div><div class="line">lock file = /var/lock/container.lock</div><div class="line"></div><div class="line">[object]</div><div class="line">max connections = 2</div><div class="line">path = /srv/node/</div><div class="line"><span class="built_in">read</span> only = False</div><div class="line">lock file = /var/lock/object.lock</div><div class="line">EOF</div><div class="line"></div><div class="line"></div><div class="line">sed -i <span class="string">"s,RSYNC_ENABLE=false,RSYNC_ENABLE=true,g"</span> /etc/default/rsync</div><div class="line"></div><div class="line">service rsync start</div></pre></td></tr></table></figure>
<h1 id="创建Ring"><a href="#创建Ring" class="headerlink" title="创建Ring"></a>创建Ring</h1><h2 id="account"><a href="#account" class="headerlink" title="account"></a>account</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/swift</div><div class="line">swift-ring-builder account.builder create 10 3 1</div><div class="line"></div><div class="line">swift-ring-builder account.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6002 --device sda --weight 100</div><div class="line">swift-ring-builder account.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6002 --device sdb --weight 100</div><div class="line">swift-ring-builder account.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6002 --device sdc --weight 100</div><div class="line"></div><div class="line">swift-ring-builder account.builder</div><div class="line">swift-ring-builder account.builder rebalance</div></pre></td></tr></table></figure>
<h2 id="container"><a href="#container" class="headerlink" title="container"></a>container</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /etc/swift</div><div class="line">swift-ring-builder container.builder create 10 3 1</div><div class="line"></div><div class="line">swift-ring-builder container.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6001 --device sda --weight 100</div><div class="line">swift-ring-builder container.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6001 --device sdb --weight 100</div><div class="line">swift-ring-builder container.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6001 --device sdc --weight 100</div><div class="line"></div><div class="line">swift-ring-builder container.builder</div><div class="line">swift-ring-builder container.builder rebalance</div></pre></td></tr></table></figure>
<h2 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h2><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd /etc/swift</div><div class="line">swift-ring-builder object.builder create 10 3 1</div><div class="line"></div><div class="line">swift-ring-builder object.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6000 --device sda --weight 100</div><div class="line">swift-ring-builder object.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6000 --device sdb --weight 100</div><div class="line">swift-ring-builder object.builder add --region 1 --zone 1 --ip 192.168.211.168 --port 6000 --device sdc --weight 100</div><div class="line"></div><div class="line">swift-ring-builder object.builder</div><div class="line">swift-ring-builder object.builder rebalance</div></pre></td></tr></table></figure>
<h1 id="swift-conf"><a href="#swift-conf" class="headerlink" title="swift.conf"></a>swift.conf</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">curl -o /etc/swift/swift.conf https://git.openstack.org/cgit/openstack/swift/plain/etc/swift.conf-sample?h=stable/mitaka</div><div class="line"></div><div class="line">crudini --set /etc/swift/swift.conf swift-hash swift_hash_path_suffix 71363a5a-ff90-4b1d-8488-cdbea12350f7</div><div class="line">crudini --set /etc/swift/swift.conf swift-hash swift_hash_path_prefix 71363a5a-ff90-4b1d-8488-cdbea12350f7</div><div class="line">crudini --set /etc/swift/swift.conf storage-policy:0 name Policy-0</div><div class="line">crudini --set /etc/swift/swift.conf storage-policy:0 default yes</div><div class="line"> </div><div class="line">chown -R root:swift /etc/swift</div><div class="line">service memcached restart</div><div class="line">swift-init all restart</div></pre></td></tr></table></figure>
<h1 id="glance"><a href="#glance" class="headerlink" title="glance"></a>glance</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;glance.sql</div><div class="line">CREATE DATABASE glance;</div><div class="line">GRANT ALL PRIVILEGES ON glance.* TO <span class="string">'glance'</span>@<span class="string">'localhost'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'GLANCE_DBPASS'</span>;</div><div class="line">GRANT ALL PRIVILEGES ON glance.* TO <span class="string">'glance'</span>@<span class="string">'%'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'GLANCE_DBPASS'</span>;</div><div class="line">EOF</div><div class="line"></div><div class="line">mysql -uroot -pmysqlpassword &lt; glance.sql</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">openstack user create --domain default --password glance glance</div><div class="line">openstack role add --project service --user glance admin</div><div class="line">openstack service create --name glance \</div><div class="line">  --description <span class="string">"OpenStack Image"</span> image</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  image public http://controller:9292</div><div class="line"></div><div class="line"> openstack endpoint create --region RegionOne \</div><div class="line">  image internal http://controller:9292</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  image admin http://controller:9292</div><div class="line"></div><div class="line">apt-get install -y glance</div><div class="line"></div><div class="line"></div><div class="line">crudini --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://controller:5000</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:35357</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken auth_type password</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name default</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name default</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken project_name service</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken username glance</div><div class="line">crudini --set /etc/glance/glance-api.conf keystone_authtoken password glance</div><div class="line">crudini --set /etc/glance/glance-api.conf paste_deploy flavor keystone</div><div class="line">crudini --set /etc/glance/glance-api.conf glance_store stores file,http</div><div class="line">crudini --set /etc/glance/glance-api.conf glance_store default_store file</div><div class="line">crudini --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/</div><div class="line"></div><div class="line">crudini --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://controller:5000</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://controller:35357</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers controller:11211</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name default</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name default</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken project_name service</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken username glance</div><div class="line">crudini --set /etc/glance/glance-registry.conf keystone_authtoken password glance</div><div class="line">crudini --set /etc/glance/glance-registry.conf paste_deploy flavor keystone</div><div class="line"></div><div class="line"></div><div class="line">su <span class="_">-s</span> /bin/sh -c <span class="string">"glance-manage db_sync"</span> glance</div><div class="line"></div><div class="line"></div><div class="line">service glance-registry restart</div><div class="line">service glance-api restart</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">wget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img</div><div class="line">openstack image create <span class="string">"cirros"</span> \</div><div class="line">  --file cirros-0.3.4-x86_64-disk.img \</div><div class="line">  --disk-format qcow2 --container-format bare \</div><div class="line">  --public</div><div class="line"> openstack image list</div></pre></td></tr></table></figure>
<h1 id="nova"><a href="#nova" class="headerlink" title="nova"></a>nova</h1> <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;nova.sql</div><div class="line">CREATE DATABASE nova_api;</div><div class="line">CREATE DATABASE nova;</div><div class="line">GRANT ALL PRIVILEGES ON nova_api.* TO <span class="string">'nova'</span>@<span class="string">'localhost'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'NOVA_DBPASS'</span>;</div><div class="line">GRANT ALL PRIVILEGES ON nova_api.* TO <span class="string">'nova'</span>@<span class="string">'%'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'NOVA_DBPASS'</span>;</div><div class="line">GRANT ALL PRIVILEGES ON nova.* TO <span class="string">'nova'</span>@<span class="string">'localhost'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'NOVA_DBPASS'</span>;</div><div class="line">GRANT ALL PRIVILEGES ON nova.* TO <span class="string">'nova'</span>@<span class="string">'%'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'NOVA_DBPASS'</span>;</div><div class="line">EOF</div><div class="line"> </div><div class="line">mysql -uroot -pmysqlpassword &lt; nova.sql</div></pre></td></tr></table></figure>
<p>利用配置生成修改命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python2.7</span></div><div class="line">import sys</div><div class="line"></div><div class="line">sec = None</div><div class="line">fn = None</div><div class="line">cnt = 0</div><div class="line">with open(<span class="string">'/tmp/ok'</span>, <span class="string">'r'</span>) as f:</div><div class="line">    lines = f.readlines()</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</div><div class="line">        <span class="keyword">if</span> cnt == 0:</div><div class="line">            fn = line.strip()</div><div class="line">            cnt = 1</div><div class="line">            <span class="built_in">continue</span></div><div class="line"></div><div class="line">        line = line.strip()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> line.find(<span class="string">'...'</span>) != -1:</div><div class="line">            <span class="built_in">continue</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> line.find(<span class="string">'['</span>) != -1:</div><div class="line">            sec = line</div><div class="line">            sec = sec.replace(<span class="string">'['</span>, <span class="string">''</span>)</div><div class="line">            sec = sec.replace(<span class="string">']'</span>, <span class="string">''</span>)</div><div class="line">            <span class="built_in">continue</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> line.find(<span class="string">'='</span>) == -1:</div><div class="line">            <span class="built_in">continue</span></div><div class="line"></div><div class="line">        line = line.replace(<span class="string">'MANAGEMENT_INTERFACE_IP_ADDRESS'</span>, <span class="string">'192.168.211.128'</span>)</div><div class="line">        words = line.split(<span class="string">'='</span>)</div><div class="line">        key = words[0].strip()</div><div class="line">        val = words[1].strip()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> val.find(<span class="string">' '</span>) != -1:</div><div class="line">            <span class="built_in">print</span> <span class="string">'crudini --set %s %s %s "%s"'</span> % (fn, sec, key, val)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="built_in">print</span> <span class="string">'crudini --set %s %s %s %s'</span> % (fn, sec, key, val)</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">openstack user create --domain default \</div><div class="line">  --password nova nova</div><div class="line"></div><div class="line">openstack role add --project service --user nova admin</div><div class="line"> openstack service create --name nova \</div><div class="line">  --description <span class="string">"OpenStack Compute"</span> compute</div><div class="line">  </div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  compute public http://controller:8774/v2.1/%\(tenant_id\)s</div><div class="line">  </div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  compute internal http://controller:8774/v2.1/%\(tenant_id\)s</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  compute admin http://controller:8774/v2.1/%\(tenant_id\)s</div><div class="line"></div><div class="line">apt-get install -y nova-api nova-conductor nova-consoleauth \</div><div class="line">  nova-novncproxy nova-scheduler</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/nova/nova.conf</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">enabled_apis = osapi_compute,metadata</div><div class="line">[api_database]</div><div class="line">...</div><div class="line">connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api</div><div class="line"></div><div class="line">[database]</div><div class="line">...</div><div class="line">connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">rpc_backend = rabbit</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">...</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = RABBIT_PASS</div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">auth_strategy = keystone</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">...</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">memcached_servers = controller:11211</div><div class="line">auth_type = password</div><div class="line">project_domain_name = default</div><div class="line">user_domain_name = default</div><div class="line">project_name = service</div><div class="line">username = nova</div><div class="line">password = nova</div><div class="line"></div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">my_ip = 192.168.211.168</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">use_neutron = True</div><div class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver</div><div class="line"></div><div class="line">[vnc]</div><div class="line">...</div><div class="line">vncserver_listen = <span class="variable">$my_ip</span></div><div class="line">vncserver_proxyclient_address = <span class="variable">$my_ip</span></div><div class="line">[glance]</div><div class="line">...</div><div class="line">api_servers = http://controller:9292</div><div class="line">[oslo_concurrency]</div><div class="line">...</div><div class="line">lock_path = /var/lib/nova/tmp</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt; /tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div><div class="line"></div><div class="line"></div><div class="line">cp -rf /etc/nova/nova.conf /etc/nova/nova.conf.bak</div><div class="line">sed -i <span class="string">"/logdir/d"</span> /etc/nova/nova.conf</div><div class="line"></div><div class="line">su <span class="_">-s</span> /bin/sh -c <span class="string">"nova-manage api_db sync"</span> nova</div><div class="line">su <span class="_">-s</span> /bin/sh -c <span class="string">"nova-manage db sync"</span> nova</div></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">service nova-api restart</div><div class="line">service nova-consoleauth restart</div><div class="line">service nova-scheduler restart</div><div class="line">service nova-conductor restart</div><div class="line">service nova-novncproxy restart</div></pre></td></tr></table></figure>
<h1 id="nova-compute"><a href="#nova-compute" class="headerlink" title="nova compute"></a>nova compute</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">apt-get install -y nova-compute</div><div class="line"></div><div class="line">cat &lt;&lt;&quot;EOF&quot;&gt;/tmp/ok</div><div class="line">/etc/nova/nova.conf</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">rpc_backend = rabbit</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">...</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = RABBIT_PASS</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">auth_strategy = keystone</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">...</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">memcached_servers = controller:11211</div><div class="line">auth_type = password</div><div class="line">project_domain_name = default</div><div class="line">user_domain_name = default</div><div class="line">project_name = service</div><div class="line">username = nova</div><div class="line">password = nova</div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">use_neutron = True</div><div class="line">firewall_driver = nova.virt.firewall.NoopFirewallDriver</div><div class="line"></div><div class="line">[vnc]</div><div class="line">...</div><div class="line">enabled = True</div><div class="line">vncserver_listen = 0.0.0.0</div><div class="line">vncserver_proxyclient_address = $my_ip</div><div class="line">novncproxy_base_url = http://controller:6080/vnc_auto.html</div><div class="line">[glance]</div><div class="line">...</div><div class="line">api_servers = http://controller:9292</div><div class="line">[oslo_concurrency]</div><div class="line">...</div><div class="line">lock_path = /var/lib/nova/tmp</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div><div class="line"></div><div class="line">cat &lt;&lt;&quot;EOF&quot;&gt;/tmp/ok</div><div class="line">/etc/nova/nova-compute.conf</div><div class="line">[libvirt]</div><div class="line">...</div><div class="line">virt_type = qemu</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div><div class="line"></div><div class="line">service nova-compute restart</div></pre></td></tr></table></figure>
<h1 id="Neutron"><a href="#Neutron" class="headerlink" title="Neutron"></a>Neutron</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;neutron.sql</div><div class="line">CREATE DATABASE neutron;</div><div class="line">GRANT ALL PRIVILEGES ON neutron.* TO <span class="string">'neutron'</span>@<span class="string">'localhost'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'NEUTRON_DBPASS'</span>;</div><div class="line">GRANT ALL PRIVILEGES ON neutron.* TO <span class="string">'neutron'</span>@<span class="string">'%'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'NEUTRON_DBPASS'</span>;</div><div class="line">EOF</div><div class="line"></div><div class="line">mysql -uroot -pmysqlpassword &lt; neutron.sql</div><div class="line"></div><div class="line">. /adminrc</div><div class="line"></div><div class="line">openstack user create --domain default --password neutron neutron</div><div class="line">openstack role add --project service --user neutron admin</div><div class="line">openstack service create --name neutron \</div><div class="line">  --description <span class="string">"OpenStack Networking"</span> network</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  network public http://controller:9696</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  network internal http://controller:9696</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  network admin http://controller:9696</div><div class="line"></div><div class="line">apt-get install -y neutron-server neutron-plugin-ml2 \</div><div class="line">  neutron-linuxbridge-agent neutron<span class="_">-l</span>3-agent neutron-dhcp-agent \</div><div class="line">  neutron-metadata-agent</div><div class="line">  </div><div class="line">apt-get install -y neutron-server neutron-plugin-ml2 neutron<span class="_">-l</span>3-agent neutron-dhcp-agent neutron-metadata-agent neutron-plugin-ml2 neutron-plugin-openvswitch-agent neutron<span class="_">-l</span>3-agent neutron-dhcp-agent</div></pre></td></tr></table></figure>
<p>设置网络转发</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">'net.ipv4.ip_forward=1'</span> &gt;&gt; /etc/sysctl.conf </div><div class="line"><span class="built_in">echo</span> <span class="string">'net.ipv4.conf.all.rp_filter=0'</span> &gt;&gt; /etc/sysctl.conf </div><div class="line"><span class="built_in">echo</span> <span class="string">'net.ipv4.conf.default.rp_filter=0'</span> &gt;&gt; /etc/sysctl.conf</div></pre></td></tr></table></figure>
<p>修改<code>interfaces</code>文件关于<code>eth0</code>的配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">allow-ovs br-ex</div><div class="line">iface br-ex inet static</div><div class="line">    address 192.168.211.168</div><div class="line">    broadcast 192.168.211.255</div><div class="line">    dns-nameservers 8.8.8.8</div><div class="line">    gateway 192.168.211.1</div><div class="line">    netmask 255.255.255.0</div><div class="line">    ovs_type OVSBridge</div><div class="line">    ovs_ports eth0</div><div class="line"></div><div class="line"><span class="comment"># The primary network interface</span></div><div class="line">allow-br-ex eth0</div><div class="line">iface eth0 inet manual</div><div class="line">	up ifconfig <span class="variable">$IFACE</span> 0.0.0.0 up</div><div class="line">	down ifconfig <span class="variable">$IFACE</span> down</div><div class="line">	ovs_bridge br-ex</div><div class="line">	ovs_type OVSPort</div><div class="line">    up ip route add default via 192.168.211.1 dev br-ex</div></pre></td></tr></table></figure>
<p>添加网桥：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ovs-vsctl add-br br-ex</div><div class="line">ovs-vsctl add-port br-ex eth0</div><div class="line">ovs-vsctl add-br br-tun</div></pre></td></tr></table></figure>
<p>更新网络配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ifdown eth0</div><div class="line">ifdown br-ex</div><div class="line">ifup br-ex</div></pre></td></tr></table></figure>
<p>备份原有配置文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cp -rf /etc/neutron /etc/back.neutron</div></pre></td></tr></table></figure>
<p>修改<code>neutron.conf</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/neutron/neutron.conf</div><div class="line">[DEFAULT]</div><div class="line">auth_strategy = keystone</div><div class="line">core_plugin = ml2</div><div class="line">service_plugins = router</div><div class="line">allow_overlapping_ips = True</div><div class="line">notify_nova_on_port_status_changes = <span class="literal">true</span></div><div class="line">notify_nova_on_port_data_changes = <span class="literal">true</span></div><div class="line">verbose = <span class="literal">true</span></div><div class="line">rpc_backend = rabbit</div><div class="line"></div><div class="line">[nova]</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_type = password</div><div class="line">project_domain_name = default</div><div class="line">user_domain_name = default</div><div class="line">region_name = RegionOne</div><div class="line">project_name = service</div><div class="line">username = nova</div><div class="line">password = nova</div><div class="line"></div><div class="line">[agent]</div><div class="line">root_helper = sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf</div><div class="line">[database]</div><div class="line">connection = mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron</div><div class="line">[keystone_authtoken]</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">memcached_servers = controller:11211</div><div class="line">auth_type = password</div><div class="line">project_domain_name = default</div><div class="line">user_domain_name = default</div><div class="line">project_name = service</div><div class="line">username = neutron</div><div class="line">password = neutron</div><div class="line">[oslo_messaging_rabbit]</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = RABBIT_PASS</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>配置ML2：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/neutron/plugins/ml2/ml2_conf.ini</div><div class="line">[DEFAULT]</div><div class="line">[ml2]</div><div class="line">type_drivers = flat,gre,vxlan</div><div class="line">tenant_network_types = gre,vxlan</div><div class="line">mechanism_drivers = openvswitch,l2population</div><div class="line">extension_drivers = port_security</div><div class="line">[ml2_type_flat]</div><div class="line">flat_networks = external</div><div class="line">[ml2_type_geneve]</div><div class="line">[ml2_type_gre]</div><div class="line">tunnel_id_ranges = 1:4096</div><div class="line">[ml2_type_vlan]</div><div class="line">[ml2_type_vxlan]</div><div class="line">vni_ranges = 1:4096</div><div class="line">[securitygroup]</div><div class="line">enable_ipset = True</div><div class="line">EOF</div><div class="line"></div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/neutron/plugins/ml2/openvswitch_agent.ini</div><div class="line">[DEFAULT]</div><div class="line"></div><div class="line">[ovs]</div><div class="line">local_ip = 192.168.211.168</div><div class="line">bridge_mappings = external:br-ex</div><div class="line"></div><div class="line">[agent]</div><div class="line">tunnel_types = gre,vxlan</div><div class="line">l2_population = True</div><div class="line">prevent_arp_spoofing = True</div><div class="line"></div><div class="line">[securitygroup]</div><div class="line">firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</div><div class="line">enable_security_group = True</div><div class="line">EOF</div><div class="line"></div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>L3 Agent的配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/neutron/l3_agent.ini</div><div class="line">[DEFAULT]</div><div class="line">verbose = True</div><div class="line">interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver</div><div class="line">use_namespaces = True</div><div class="line">external_network_bridge = br-ex</div><div class="line">[AGENT]</div><div class="line">EOF</div><div class="line"></div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>配置DHCP</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"dhcp-option-force=26,1450"</span> &gt; /etc/neutron/dnsmasq-neutron.conf</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/neutron/dhcp_agent.ini</div><div class="line">[DEFAULT]</div><div class="line"></div><div class="line">verbose = True</div><div class="line">interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver</div><div class="line">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</div><div class="line">enable_isolated_metadata = True</div><div class="line">dnsmasq_config_file = /etc/neutron/dnsmasq-neutron.conf</div><div class="line">[AGENT]</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>配置metadata</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/neutron/metadata_agent.ini</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">nova_metadata_ip = controller</div><div class="line">metadata_proxy_shared_secret = METADATA_SECRET</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>Nova添加Neutron服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/nova/nova.conf</div><div class="line">[neutron]</div><div class="line">...</div><div class="line">url = http://controller:9696</div><div class="line">auth_url = http://controller:35357</div><div class="line">auth_type = password</div><div class="line">project_domain_name = default</div><div class="line">user_domain_name = default</div><div class="line">region_name = RegionOne</div><div class="line">project_name = service</div><div class="line">username = neutron</div><div class="line">password = neutron</div><div class="line"></div><div class="line">service_metadata_proxy = True</div><div class="line">metadata_proxy_shared_secret = METADATA_SECRET</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>同步数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">su <span class="_">-s</span> /bin/sh -c <span class="string">"neutron-db-manage --config-file /etc/neutron/neutron.conf \</span></div><div class="line">  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron</div></pre></td></tr></table></figure>
<p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">service nova-api restart</div><div class="line">service neutron-server restart</div><div class="line">service neutron-openvswitch-agent restart</div><div class="line">service neutron-dhcp-agent restart</div><div class="line">service neutron-metadata-agent restart</div><div class="line">service neutron<span class="_">-l</span>3-agent restart</div></pre></td></tr></table></figure>
<p>查看服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">neutron ext-list</div><div class="line">neutron agent-list</div></pre></td></tr></table></figure>
<h1 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y openstack-dashboard</div></pre></td></tr></table></figure>
<p>修改<code>/etc/openstack-dashboard/local_settings.py</code>:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">file=<span class="string">"/etc/openstack-dashboard/local_settings.py"</span></div><div class="line">cp -rf <span class="variable">$file</span> <span class="variable">$&#123;file&#125;</span>.bak</div><div class="line"></div><div class="line">sed -i <span class="string">"s,#OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = False,OPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True,g"</span> <span class="variable">$file</span></div><div class="line">sed -i <span class="string">"s,#OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = 'default',OPENSTACK_KEYSTONE_DEFAULT_DOMAIN = 'default',g"</span> <span class="variable">$file</span></div><div class="line"></div><div class="line">service apache2 reload</div></pre></td></tr></table></figure>
<h1 id="Ceph"><a href="#Ceph" class="headerlink" title="Ceph"></a>Ceph</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">echo</span> deb https://download.ceph.com/debian-jewel/ $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/ceph.list</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/addkey</div><div class="line">gpg --keyserver keyserver.ubuntu.com --recv <span class="variable">$1</span></div><div class="line">gpg --keyserver keyserver.debian.com --recv-keys <span class="variable">$1</span></div><div class="line">gpg --export --armor <span class="variable">$1</span> | apt-key add -</div><div class="line">EOF</div><div class="line"></div><div class="line">chmod +x /tmp/addkey</div><div class="line">/tmp/addkey E84AC2C0460F3994</div><div class="line"></div><div class="line">apt-get update</div><div class="line"></div><div class="line">apt-get install -y --force-yes ceph-common ceph</div></pre></td></tr></table></figure>
<h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">wget -qO- https://get.docker.com | sh</div><div class="line"></div><div class="line">apt-get install -y build-essential ipcalc</div><div class="line"><span class="built_in">cd</span> /tmp; curl https://www.kernel.org/pub/linux/utils/util-linux/v2.24/util-linux-2.24.tar.gz | tar -zxf-; <span class="built_in">cd</span> util-linux-2.24;</div><div class="line">./configure --without-ncurses</div><div class="line">make nsenter &amp;&amp; sudo cp nsenter /usr/<span class="built_in">local</span>/bin</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;&gt;/etc/profile</div><div class="line"><span class="keyword">function</span> docker-<span class="function"><span class="title">enter</span></span>() &#123;</div><div class="line">    PID=$(docker inspect --format <span class="string">"&#123;&#123; .State.Pid &#125;&#125;"</span> <span class="variable">$1</span>)</div><div class="line">    nsenter --target <span class="variable">$PID</span> --mount --uts --ipc --net --pid</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">cip</span></span>() &#123;</div><div class="line">    docker inspect --format <span class="string">'&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;'</span> <span class="variable">$1</span></div><div class="line">&#125;</div><div class="line">EOF</div><div class="line"></div><div class="line"></div><div class="line">docker pull ceph/demo</div><div class="line"></div><div class="line">local_ip=$(ifconfig br-ex | grep <span class="string">"inet addr"</span> | awk -F : <span class="string">'&#123;print $2&#125;'</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</div><div class="line">local_cidr=$(ipcalc -n <span class="variable">$local_ip</span> 255.255.255.0 | grep <span class="string">"Network"</span> | awk <span class="string">'&#123;print $2&#125;'</span>)</div><div class="line">docker run -idt --net=host -v /etc/ceph:/etc/ceph <span class="_">-e</span> MON_IP=<span class="variable">$local_ip</span> <span class="_">-e</span> CEPH_NETWORK=<span class="variable">$local_cidr</span> <span class="_">-e</span> CEPH_PUBLIC_NETWORK=<span class="variable">$local_cidr</span> --name ceph ceph/demo</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 然后在/etc/rc.local中添加docker start ceph，系统启动的时候，会自动启动ceph container.</span></div></pre></td></tr></table></figure>
<h1 id="安装Cinder-需要重新整理"><a href="#安装Cinder-需要重新整理" class="headerlink" title="安装Cinder (需要重新整理)"></a>安装Cinder (需要重新整理)</h1><p>重要参考：</p>
<p><a href="https://kairen.gitbooks.io/openstack-ubuntu/content/deployments/ubuntu/cinder/ceph-cinder.html" target="_blank" rel="external">https://kairen.gitbooks.io/openstack-ubuntu/content/deployments/ubuntu/cinder/ceph-cinder.html</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;cinder.sql</div><div class="line">CREATE DATABASE cinder;</div><div class="line">GRANT ALL PRIVILEGES ON cinder.* TO <span class="string">'cinder'</span>@<span class="string">'localhost'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'CINDER_DBPASS'</span>;</div><div class="line">GRANT ALL PRIVILEGES ON cinder.* TO <span class="string">'cinder'</span>@<span class="string">'%'</span> \</div><div class="line">  IDENTIFIED BY <span class="string">'CINDER_DBPASS'</span>;</div><div class="line">EOF</div><div class="line"></div><div class="line">mysql -uroot -pmysqlpassword &lt; cinder.sql</div><div class="line"></div><div class="line"></div><div class="line">. /adminrc</div><div class="line"></div><div class="line">openstack user create --domain default --password cinder cinder</div><div class="line">openstack role add --project service --user cinder admin</div><div class="line"></div><div class="line">openstack service create --name cinder \</div><div class="line">  --description <span class="string">"OpenStack Block Storage"</span> volume</div><div class="line"></div><div class="line">openstack service create --name cinderv2 \</div><div class="line">  --description <span class="string">"OpenStack Block Storage"</span> volumev2</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  volume public http://controller:8776/v1/%\(tenant_id\)s</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  volume internal http://controller:8776/v1/%\(tenant_id\)s</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  volume admin http://controller:8776/v1/%\(tenant_id\)s</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  volumev2 public http://controller:8776/v2/%\(tenant_id\)s</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  volumev2 internal http://controller:8776/v2/%\(tenant_id\)s</div><div class="line"></div><div class="line">openstack endpoint create --region RegionOne \</div><div class="line">  volumev2 admin http://controller:8776/v2/%\(tenant_id\)s</div><div class="line">  </div><div class="line"></div><div class="line">apt-get install -y cinder-api cinder-scheduler</div></pre></td></tr></table></figure>
<p>修改<code>cinder-api</code>节点的配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/cinder/cinder.conf</div><div class="line">[database]</div><div class="line">...</div><div class="line">connection = mysql+pymysql://cinder:CINDER_DBPASS@controller/cinder</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">rpc_backend = rabbit</div><div class="line"></div><div class="line">[oslo_messaging_rabbit]</div><div class="line">...</div><div class="line">rabbit_host = controller</div><div class="line">rabbit_userid = openstack</div><div class="line">rabbit_password = RABBIT_PASS</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">auth_strategy = keystone</div><div class="line"></div><div class="line">[keystone_authtoken]</div><div class="line">...</div><div class="line">auth_uri = http://controller:5000</div><div class="line">auth_url = http://controller:35357</div><div class="line">memcached_servers = controller:11211</div><div class="line">auth_type = password</div><div class="line">project_domain_name = default</div><div class="line">user_domain_name = default</div><div class="line">project_name = service</div><div class="line">username = cinder</div><div class="line">password = cinder</div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">my_ip = 192.168.211.168</div><div class="line"></div><div class="line">[oslo_concurrency]</div><div class="line">...</div><div class="line">lock_path = /var/lib/cinder/tmp</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>同步数据库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">su <span class="_">-s</span> /bin/sh -c <span class="string">"cinder-manage db sync"</span> cinder</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/nova/nova.conf</div><div class="line">[cinder]</div><div class="line">os_region_name = RegionOne</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div><div class="line"></div><div class="line">service nova-api restart</div><div class="line">service cinder-scheduler restart</div><div class="line">service cinder-api restart</div></pre></td></tr></table></figure>
<p>配置存储服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install -y cinder-volume</div></pre></td></tr></table></figure>
<p>开始设置libvirt/ceph</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">ceph osd pool create cinder 128 128</div><div class="line">ceph auth get-or-create client.cinder mon <span class="string">'allow r'</span> osd <span class="string">'allow class-read object_prefix rbd_children, allow rwx pool=cinder'</span> &gt; /etc/ceph/ceph.client.cinder.keying</div><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;sec.xml</div><div class="line">&lt;secret ephemeral=<span class="string">'no'</span> private=<span class="string">'no'</span>&gt;</div><div class="line">  &lt;uuid&gt;5ffc7545-08d7-481a-be52-42b4c71e6e34&lt;/uuid&gt;</div><div class="line">  &lt;usage <span class="built_in">type</span>=<span class="string">'ceph'</span>&gt;</div><div class="line">    &lt;name&gt;client.cinder secret&lt;/name&gt;</div><div class="line">  &lt;/usage&gt;</div><div class="line">&lt;/secret&gt;</div><div class="line">EOF</div><div class="line"></div><div class="line">virsh secret-define --file sec.xml</div><div class="line"></div><div class="line">key=`cat /etc/ceph/ceph.client.cinder.keying | grep key | awk <span class="string">'&#123;print $3&#125;'</span>`</div><div class="line"></div><div class="line">virsh secret-set-value --secret 5ffc7545-08d7-481a-be52-42b4c71e6e34 --base64 <span class="variable">$key</span></div></pre></td></tr></table></figure>
<p>修改存储节点的配置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">cat &lt;&lt;<span class="string">"EOF"</span>&gt;/tmp/ok</div><div class="line">/etc/cinder/cinder.conf</div><div class="line">[ceph]</div><div class="line">rbd_secret_uuid=5ffc7545-08d7-481a-be52-42b4c71e6e34</div><div class="line">rbd_cluster_name=ceph</div><div class="line">rbd_flatten_volume_from_snapshot=False</div><div class="line">rbd_user=cinder</div><div class="line">volume_backend_name=ceph</div><div class="line">rbd_ceph_conf=/etc/ceph/ceph.conf</div><div class="line">rbd_pool=cinder</div><div class="line">volume_driver=cinder.volume.drivers.rbd.RBDDriver</div><div class="line">rbd_max_clone_depth=5</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">enabled_backends = ceph</div><div class="line">default_volume_type=ceph</div><div class="line">[DEFAULT]</div><div class="line">...</div><div class="line">glance_api_servers = http://controller:9292</div><div class="line">[oslo_concurrency]</div><div class="line">...</div><div class="line">lock_path = /var/lib/cinder/tmp</div><div class="line">EOF</div><div class="line"></div><div class="line">/home/openstack/gen &gt;/tmp/cmd.sh</div><div class="line">chmod +x /tmp/cmd.sh</div><div class="line">/tmp/cmd.sh</div></pre></td></tr></table></figure>
<p>重启服务：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">service cinder-volume restart</div><div class="line">service cinder-api restart</div><div class="line">service cinder-scheduler restart</div></pre></td></tr></table></figure>
<h1 id="开始测试"><a href="#开始测试" class="headerlink" title="开始测试"></a>开始测试</h1><h2 id="创建公有网络"><a href="#创建公有网络" class="headerlink" title="创建公有网络"></a>创建公有网络</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">neutron net-create --shared --provider:physical_network external \</div><div class="line">  --provider:network_type flat external</div><div class="line"></div><div class="line"></div><div class="line">neutron subnet-create --name external \</div><div class="line">  --allocation-pool start=192.168.211.200,end=192.168.211.253 \</div><div class="line">  --dns-nameserver 8.8.8.8 --gateway 192.168.211.1 \</div><div class="line">  external 192.168.211.1/24</div></pre></td></tr></table></figure>
<h2 id="创建私有网络"><a href="#创建私有网络" class="headerlink" title="创建私有网络"></a>创建私有网络</h2><p>利用demo用户来创建网络</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">. /demorc</div><div class="line">neutron net-create selfservice</div><div class="line">neutron subnet-create --name selfservice \</div><div class="line">  --dns-nameserver 8.8.8.8 --gateway 172.16.1.1 \</div><div class="line">  selfservice 172.16.1.0/24</div></pre></td></tr></table></figure>
<h2 id="创建路由"><a href="#创建路由" class="headerlink" title="创建路由"></a>创建路由</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">. /adminrc</div><div class="line">neutron net-update external --router:external</div><div class="line">``</div><div class="line"></div><div class="line">```bash</div><div class="line">. /demorc</div><div class="line">neutron router-create router</div><div class="line">neutron router-interface-add router selfservice</div><div class="line">neutron router-gateway-set router external</div></pre></td></tr></table></figure>
<h2 id="验证网络操作"><a href="#验证网络操作" class="headerlink" title="验证网络操作"></a>验证网络操作</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ip netns</div><div class="line">. /adminrc</div><div class="line">neutron router-port-list router</div><div class="line">. /demorc</div><div class="line">neutron router-port-list router</div></pre></td></tr></table></figure>
<h2 id="准备创建虚拟机"><a href="#准备创建虚拟机" class="headerlink" title="准备创建虚拟机"></a>准备创建虚拟机</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">. /adminrc</div><div class="line">openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano</div></pre></td></tr></table></figure>
<h2 id="加入key"><a href="#加入key" class="headerlink" title="加入key"></a>加入key</h2><p>先切到openstack用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ssh-keygen</div><div class="line"></div><div class="line"></div><div class="line">openstack keypair create --public-key ~/.ssh/id_rsa.pub openstack</div><div class="line"></div><div class="line">. /demorc</div><div class="line">openstack keypair create --public-key ~/.ssh/id_rsa.pub openstack</div><div class="line"></div><div class="line">openstack security group rule create --proto icmp default</div><div class="line">openstack security group rule create --proto tcp --dst-port 22 default</div></pre></td></tr></table></figure>
<h1 id="开始启动虚拟机"><a href="#开始启动虚拟机" class="headerlink" title="开始启动虚拟机"></a>开始启动虚拟机</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">. /demorc</div><div class="line">openstack flavor list</div><div class="line">openstack flavor list</div></pre></td></tr></table></figure>
      
    </div>
    
    <div class="article-info article-info-index">
      
      
      

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-install-openstack" data-title="install.openstack" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-docker-openstack" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/19/docker-openstack/" class="article-date">
  	<time datetime="2016-09-19T12:04:13.000Z" itemprop="datePublished">2016-09-19</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/19/docker-openstack/">Docker安装OpenStack</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h1><p>在安装的时候，尽管写脚本是一种比较好的安装方式。</p>
<ul>
<li>但是脚本并不能实时的进行测试。</li>
<li>每个人的安装环境各不相同。</li>
<li>脚本有可能不能满足所有人的安装需求。</li>
</ul>
<p>那么采用<code>Docker</code>来进行安装，则是一种比较有意思并且可移植的方法。下面介绍基于<code>Docker</code>安装<code>OpenStack</code>的方法，注意这里的目标是：</p>
<ul>
<li>尽量把能安装的组件都安装到Docker里面。</li>
<li>希望提供微服务功能，也就是说，把OpenStack的组件分开安装到各个<code>Docker</code>的<code>Container</code>里面。</li>
<li><code>nova-compute</code>也希望能够放进去。</li>
</ul>
<h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><p>做实验的环境如下：</p>
<ul>
<li>Host OS: Ubuntu 14.04</li>
<li>Docker version 1.12.1, build 23cf638</li>
</ul>
<p>安装OpenStack的链接可以参考：<a href="http://docs.openstack.org/mitaka/zh_CN/install-guide-ubuntu/environment.html" target="_blank" rel="external">http://docs.openstack.org/mitaka/zh_CN/install-guide-ubuntu/environment.html</a></p>
<h1 id="安装依赖组件"><a href="#安装依赖组件" class="headerlink" title="安装依赖组件"></a>安装依赖组件</h1><h2 id="ntp"><a href="#ntp" class="headerlink" title="ntp"></a>ntp</h2><p>首先新建一个目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mkdir -p ntp</div><div class="line"><span class="built_in">cd</span> ntp</div></pre></td></tr></table></figure>
<h3 id="chrony-conf"><a href="#chrony-conf" class="headerlink" title="chrony.conf"></a>chrony.conf</h3><p>编写<code>chrony.conf</code>的配置文件如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><div class="line">server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> iburst</div><div class="line">keyfile /etc/chrony/chrony.keys</div><div class="line">commandkey <span class="number">1</span></div><div class="line">driftfile /var/lib/chrony/chrony.drift</div><div class="line">log tracking measurements statistics</div><div class="line">logdir /var/log/chrony</div><div class="line">maxupdateskew <span class="number">100.0</span></div><div class="line">dumponexit</div><div class="line">dumpdir /var/lib/chrony</div><div class="line">local stratum <span class="number">10</span></div><div class="line">allow all</div><div class="line"></div><div class="line">logchange <span class="number">0.5</span></div><div class="line">rtconutc</div></pre></td></tr></table></figure>
<h3 id="chrony-keys"><a href="#chrony-keys" class="headerlink" title="chrony.keys"></a>chrony.keys</h3><p>然后再编写<code>chrony.keys</code>如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><div class="line"><span class="number">1</span> <span class="number">2</span>dd8iWgV</div></pre></td></tr></table></figure>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>然后再编写<code>Dockerfile</code>文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">FROM ubuntu:16.04</div><div class="line">MAINTAINER Jerry.Ji &quot;youji@ebay.com&quot;</div><div class="line"></div><div class="line">RUN apt-get -y update</div><div class="line">RUN apt-get install -y chrony</div><div class="line">ADD chrony.conf /etc/chrony/chrony.conf</div><div class="line">ADD chrony.keys /etc/chrony/chrony.keys</div><div class="line"></div><div class="line">CMD [&quot;chronyd&quot;, &quot;-d&quot;]</div></pre></td></tr></table></figure>
<h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><p>然后再编写<code>build/run</code>的脚本：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">FROM ubuntu:16.04</div><div class="line">MAINTAINER Jerry.Ji <span class="string">"youji@ebay.com"</span></div><div class="line"></div><div class="line"><span class="comment"># Install s3cmd to support creation of buckets</span></div><div class="line">RUN apt-get -y update</div><div class="line">RUN apt-get install -y chrony</div><div class="line">ADD chrony.conf /etc/chrony/chrony.conf</div><div class="line">ADD chrony.keys /etc/chrony/chrony.keys</div><div class="line"></div><div class="line">CMD [<span class="string">"chronyd"</span>, <span class="string">"-d"</span>]</div><div class="line">root@build-package-preprod-4597:~/DockerOpenStack/ntp<span class="comment"># cat run.sh</span></div><div class="line">docker build -t <span class="string">"openstack:ntp"</span> .</div><div class="line">docker rm <span class="_">-f</span> ntp</div><div class="line">docker run -idt --privileged --name ntp openstack:ntp</div></pre></td></tr></table></figure>
<h3 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h3><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">./run.sh</div></pre></td></tr></table></figure>
<p>即可。自己做的ntp服务，一定要注意:</p>
<ul>
<li>–privileged</li>
<li>ubuntu:16.04</li>
</ul>
<h2 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h2><p>由于每个<code>Container</code>都是需要安装<code>OpenStack Mitaka</code>的源。所以在这里需要对源做一些处理，也就是让源目录/包下载目录共享出来。所以这里需要/etc/apt目录与/var/目录共享出来。</p>
<h3 id="Dockerfile-1"><a href="#Dockerfile-1" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>建立<code>Dockerfile</code>文件如下：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><div class="line">FROM ubuntu:<span class="number">14.04</span></div><div class="line">MAINTAINER Jerry.Ji <span class="string">"youji@ebay.com"</span></div><div class="line"></div><div class="line">RUN apt-get -y update</div><div class="line">RUN apt-get install -y software-properties-common</div><div class="line">RUN add-apt-repository -y cloud-archive:mitaka</div><div class="line">RUN apt-get -y update &amp;&amp; apt-get -y dist-upgrade</div><div class="line">VOLUME [<span class="string">"/etc/apt/"</span>, <span class="string">"/var/cache/apt/"</span>]</div><div class="line">CMD [<span class="string">"/bin/bash"</span>]</div></pre></td></tr></table></figure>
<h3 id="run-sh-1"><a href="#run-sh-1" class="headerlink" title="run.sh"></a>run.sh</h3><p><code>build</code>脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">docker build -t <span class="string">"openstack:apt"</span> .</div><div class="line">docker rm <span class="_">-f</span> apt</div><div class="line">docker run -idt --privileged --name apt openstack:apt</div></pre></td></tr></table></figure>
<h2 id="Mariadb"><a href="#Mariadb" class="headerlink" title="Mariadb"></a>Mariadb</h2><p>这里接下来安装<code>mariadb</code>。这里就不自己造轮子了，直接用现有的Image。注意<code>root</code>的密码。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">docker rm <span class="_">-f</span> db</div><div class="line">docker run -idt <span class="_">-e</span> MYSQL_ROOT_PASSWORD=mypass --name db mariadb</div></pre></td></tr></table></figure>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">docker rm <span class="_">-f</span> rabbitmq</div><div class="line">docker run -idt --name rabbitmq <span class="_">-e</span> RABBITMQ_DEFAULT_USER=openstack <span class="_">-e</span> RABBITMQ_DEFAULT_PASS=RABBIT_PASS rabbitmq</div></pre></td></tr></table></figure>
<h2 id="Memcache"><a href="#Memcache" class="headerlink" title="Memcache"></a>Memcache</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">docker rm <span class="_">-f</span> memcached</div><div class="line">docker run -idt --name memcached  memcached</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/OpenStack/">OpenStack</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/blog/categories/OpenStack/">OpenStack</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-docker-openstack" data-title="Docker安装OpenStack" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-ceph-woboq" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/18/ceph-woboq/" class="article-date">
  	<time datetime="2016-09-18T06:20:29.000Z" itemprop="datePublished">2016-09-18</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/18/ceph-woboq/">Ceph通过WoboQ阅读源码</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h1><p>主要原因还是因为看了这篇文章：<a href="https://zhuanlan.zhihu.com/p/22484207。然后点开了WoboQ的主页，觉得实在是看起来太爽。https://code.woboq.org/。所以决定也用来看看`Ceph`的代码。后面也可以尝试看看是否可以用来看`xv6`的代码。" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/22484207。然后点开了WoboQ的主页，觉得实在是看起来太爽。https://code.woboq.org/。所以决定也用来看看`Ceph`的代码。后面也可以尝试看看是否可以用来看`xv6`的代码。</a></p>
<p><strong>界面太爽，功能强大</strong> 强烈推荐。比<code>Source Insight</code>好用多了。</p>
<h1 id="安装WoboQ"><a href="#安装WoboQ" class="headerlink" title="安装WoboQ"></a>安装WoboQ</h1><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get update</div><div class="line">apt-get install clang-3.8 llvm-3.8 libclang-3.8-dev</div><div class="line"><span class="built_in">cd</span> /var/www/html</div><div class="line">git <span class="built_in">clone</span> https://github.com/woboq/woboq_codebrowser</div><div class="line"><span class="built_in">cd</span> woboq_codebrowser</div><div class="line">cmake . -DLLVM_CONFIG_EXECUTABLE=/usr/bin/llvm-config-3.8 -DCMAKE_BUILD_TYPE=Release</div><div class="line">make -j24</div></pre></td></tr></table></figure>
<p>看到如下输出：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">[100%] Built target codebrowser_generator</div></pre></td></tr></table></figure>
<p>表示编译成功。</p>
<h1 id="Cmake-amp-Ceph"><a href="#Cmake-amp-Ceph" class="headerlink" title="Cmake &amp; Ceph"></a>Cmake &amp; Ceph</h1><p>参考：<a href="http://fossies.org/linux/ceph/README.cmake.md" target="_blank" rel="external">http://fossies.org/linux/ceph/README.cmake.md</a></p>
<p>进入到<code>Ceph</code>源码目录，运行如下命令:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">git reset --hard</div><div class="line">git clean -df</div><div class="line">./run-cmake-check.sh -DCMAKE_EXPORT_COMPILE_COMMANDS=ON</div></pre></td></tr></table></figure>
<p><strong>注意</strong>如果之前用过其他的<code>build</code>比如<code>cmake</code>来编译过<code>Ceph</code>代码，那么务必运行<code>git reset --hard; git clean -df</code>先进行清理工作。</p>
<h1 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h1><p>当编译成功之后，可以检查内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">cat build/compile_commands.json</div></pre></td></tr></table></figure>
<h1 id="生成html"><a href="#生成html" class="headerlink" title="生成html"></a>生成html</h1><p>然后进入到<code>Ceph</code>根目录下的<code>build</code>目录：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">OUTPUTDIRECTORY=/var/www/html/ceph/build/ceph_html</div><div class="line">DATADIRECTORY=<span class="variable">$OUTPUTDIRECTORY</span>/../data</div><div class="line">BUILDIRECTORY=`<span class="built_in">pwd</span>`</div><div class="line">VERSION=<span class="string">"v11.0.0"</span></div><div class="line">/var/www/html/woboq_codebrowser/generator/codebrowser_generator -b <span class="variable">$BUILDIRECTORY</span> -o <span class="variable">$OUTPUTDIRECTORY</span> -p codebrowser:<span class="variable">$BUILDIRECTORY</span>:<span class="variable">$VERSION</span> src</div><div class="line">/var/www/html/woboq_codebrowser/indexgenerator/codebrowser_indexgenerator <span class="variable">$OUTPUTDIRECTORY</span></div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/ceph/">ceph</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/woboq/">woboq</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/blog/categories/ceph/">ceph</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-ceph-woboq" data-title="Ceph通过WoboQ阅读源码" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-jos-lab1-a" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/16/jos-lab1-a/" class="article-date">
  	<time datetime="2016-09-15T23:28:32.000Z" itemprop="datePublished">2016-09-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/16/jos-lab1-a/">MIT 6.828 JOS课程1：HW Boot xv6</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Homework-boot-xv6"><a href="#Homework-boot-xv6" class="headerlink" title="Homework: boot xv6"></a>Homework: boot xv6</h1><p>作业链接：<a href="https://pdos.csail.mit.edu/6.828/2016/homework/xv6-boot.html" target="_blank" rel="external">https://pdos.csail.mit.edu/6.828/2016/homework/xv6-boot.html</a></p>
<h1 id="查看地址"><a href="#查看地址" class="headerlink" title="查看地址"></a>查看地址</h1><p>这里是为了查看进入内核的入口函数，运行命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /opt/xv6-public</div><div class="line">nm kernel | grep _start</div></pre></td></tr></table></figure>
<p>可以得到如下输出：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">jiyou-qt@jiyou-qt:~/writeos/xv6-public$ nm kernel | grep _start</div><div class="line">8010a48c D _binary_entryother_start</div><div class="line">8010a460 D _binary_initcode_start</div><div class="line">0010000c T _start</div></pre></td></tr></table></figure>
<p>可以看到，最后一行的起始地址为<code>kernel</code>的入口函数地址。</p>
<h1 id="Task-1-GDB入口地址"><a href="#Task-1-GDB入口地址" class="headerlink" title="Task 1. GDB入口地址"></a>Task 1. GDB入口地址</h1><p>这里需要打开两个终端，一个作为<code>gdb-server</code>，一个是作为<code>gdb-client</code>。这个比较简单，实际上是通过实例说明一下gdb的使用。不过在前面的博文中已经介绍过了。</p>
<p><strong>gdb-server</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /opt/xv6-public</div><div class="line"></div><div class="line"><span class="comment"># 下面的命令只需要选择一个来执行。</span></div><div class="line"><span class="comment"># Choice 1. 如果ubuntu有UI界面，并且处在UI界面中，运行如下命令。</span></div><div class="line">make qemu-gdb</div><div class="line"></div><div class="line"><span class="comment"># Choice 2. 如果ubuntu没有UI界面，那么运行:</span></div><div class="line">make qemu-nox-gdb</div></pre></td></tr></table></figure></p>
<p><strong>gdb-client</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /opt/xv6-public</div><div class="line">gdb</div></pre></td></tr></table></figure></p>
<p>可以得到如下输出：</p>
<p><img src="/blog/img/gdb-start.jpeg" alt=""></p>
<h1 id="Task-2-What-is-on-the-stack"><a href="#Task-2-What-is-on-the-stack" class="headerlink" title="Task 2. What is on the stack?"></a>Task 2. What is on the stack?</h1><p>在gdb中查看寄存器可以使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) info reg</div><div class="line">...</div></pre></td></tr></table></figure>
<p>查看栈指针的内容：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) x/24x <span class="variable">$esp</span></div><div class="line">...</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>作业内容：英文原文</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Write a short (3-5 word) comment next to each non-zero value on the stack explaining what it is. Which part of the stack printout is actually the stack? (Hint: not all of it.)</div><div class="line"></div><div class="line">You might find it convenient to consult the files bootasm.S, bootmain.c, and bootblock.asm (which contains the output of the compiler/assembler). The reference page has pointers to x86 assembly documentation, if you are wondering about the semantics of a particular instruction. Your goal is to understand and explain the contents of the stack that you saw above, just after entering the xv6 kernel. One way to achieve this would be to observe how and where the stack gets setup during early boot and then track the changes to the stack up until the point you are interested in. Here are some questions to help you along:</div></pre></td></tr></table></figure>
<ul>
<li>Begin by restarting qemu and gdb, and set a break-point at 0x7c00, the start of the boot block (bootasm.S). Single step through the instructions (type si at the gdb prompt). Where in bootasm.S is the stack pointer initialized? (Single step until you see an instruction that moves a value into %esp, the register for the stack pointer.)</li>
<li>Single step through the call to bootmain; what is on the stack now?</li>
<li>What do the first assembly instructions of bootmain do to the stack? Look for bootmain in bootblock.asm.</li>
<li>Continue tracing via gdb (using breakpoints if necessary – see hint below) and look for the call that changes eip to 0x10000c. What does that call do to the stack? (Hint: Think about what this call is trying to accomplish in the boot sequence and try to identify this point in bootmain.c, and the corresponding instruction in the bootmain code in bootblock.asm. This might help you set suitable breakpoints to speed things up.)</li>
</ul>
<p>翻译如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">写一个简单的注释来说明一下栈中每个非0的数据表示啥意思。Stack输出的哪部分是真正表示了这个stack。</div><div class="line"></div><div class="line">可能会发现比较容易查询到文件bootasm.S, bootmain.c, bootblock.asm，这三个文件包含了编译器与汇编器的输出。参考链接(https://pdos.csail.mit.edu/6.828/2016/reference.html)里面包含了x86汇编语言的文档。如果你对某些指令有疑问，那么下面这些问题可以帮助到你：</div><div class="line"></div><div class="line">Start by setting a break-point at 0x7c00, the start of the boot block (bootasm.S).</div><div class="line"></div><div class="line">1. 在0x7c00处设置一个断点，应该可以发现这是启动的第一条指令。bootasm.S的开始执行的地方。</div><div class="line"></div><div class="line">2. 接下来，利用gdb中的si命令单步执行。找到bootasm.S中stack是在哪里初始化的？(注意：单步执行，直到你找到某条指令把某个值移动到了%esp寄存器中。%esp也就是栈指针。)</div><div class="line"></div><div class="line">3. 当代码跳转到bootmain的时候，这个时候栈里面又存放的是什么？</div><div class="line"></div><div class="line">4. 在bootmain里面的第一条汇编指令对这个stack做啥了？快去查看bootblock.asm吧，bootmain就在里面。</div><div class="line"></div><div class="line">5. 查看在bootblock.asm里面的bootmain，找到调用call。这个call会把%eip指向0x10000c。这个call对栈又做了啥？</div><div class="line"></div><div class="line">6. 提交注决：x/24x %esp的有效输出，应该就是说非0的那一部分，以及你的comment。把这个作业写到hwN.txt里面。N表示的是第几次作业。</div></pre></td></tr></table></figure>
<h1 id="答案"><a href="#答案" class="headerlink" title="答案"></a>答案</h1><h2 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h2><p>阅读<strong>李忠《x86汇编语言－从实模式到保护模式》</strong>第五章，会找到最好的答案。</p>
<h2 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h2><p>问题是需要找到<code>bootasm.S</code>中在哪里把<code>stack</code>给初始化了？代码比较容易看懂。也就是在<code>bootasm.S</code>的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line"># Set up the stack pointer and call into C.</div><div class="line">movl    $start, %esp   &lt;-- 就在这里</div><div class="line">call    bootmain</div></pre></td></tr></table></figure>
<p>但是这前后的原理还是需要自己摸索。</p>
<h3 id="Q-2-1-刚启动的情况"><a href="#Q-2-1-刚启动的情况" class="headerlink" title="Q.2.1 刚启动的情况"></a>Q.2.1 刚启动的情况</h3><p>利用<code>gdb</code>进行调试：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) br * 0x7c00    <span class="comment"># &lt;-- 设置断点</span></div><div class="line">Breakpoint 1 at 0x7c00</div><div class="line">(gdb) c              <span class="comment"># &lt;-- 让程序开始执行到断点处，停下来。</span></div><div class="line">Continuing.</div><div class="line">[   0:7c00] =&gt; 0x7c00:	cli</div><div class="line"></div><div class="line">Breakpoint 1, 0x00007c00 <span class="keyword">in</span> ?? ()</div><div class="line">(gdb) si</div><div class="line">[   0:7c01] =&gt; 0x7c01:	xor    %ax,%ax</div><div class="line">0x00007c01 <span class="keyword">in</span> ?? ()</div><div class="line">(gdb) info reg</div><div class="line">eax            0xaa55	43605</div><div class="line">ecx            0x0	0</div><div class="line">edx            0x80	128</div><div class="line">ebx            0x0	0</div><div class="line">esp            0x6f2c	0x6f2c  <span class="comment"># &lt;-- 注意esp的值。</span></div><div class="line">ebp            0x0	0x0</div><div class="line">esi            0x0	0</div><div class="line">edi            0x0	0</div><div class="line">eip            0x7c01	0x7c01</div><div class="line">eflags         0x2	[ ]</div><div class="line">cs             0x0	0</div><div class="line">ss             0x0	0          <span class="comment"># &lt;-- 注意ss的值。</span></div><div class="line">ds             0x0	0</div><div class="line">es             0x0	0</div><div class="line">fs             0x0	0</div><div class="line">gs             0x0	0</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>当前还在实模式下。<code>0x6f2c</code>处在<code>0x7c00</code>之下，因此，形成的结构如下：</p>
<p><img src="/blog/img/lab1.a/lab1.a.boot-up.mem.jpeg.001.jpeg.001.jpeg.001.jpeg" alt=""></p>
<h3 id="Q-2-2-设置ss栈段寄存器"><a href="#Q-2-2-设置ss栈段寄存器" class="headerlink" title="Q.2.2 设置ss栈段寄存器"></a>Q.2.2 设置ss栈段寄存器</h3> <figure class="highlight c"><table><tr><td class="code"><pre><div class="line">mov %ax, %ss</div></pre></td></tr></table></figure>
<p> 得到的结果如下：</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"> (gdb) si</div><div class="line">=&gt; 0x7c3b:	mov    <span class="variable">$0x0</span>,%ax</div><div class="line">0x00007c3b <span class="keyword">in</span> ?? ()</div><div class="line">(gdb) info reg</div><div class="line">eax            0x10	16</div><div class="line">ecx            0x0	0</div><div class="line">edx            0x80	128</div><div class="line">ebx            0x0	0</div><div class="line">esp            0x6f2c	0x6f2c</div><div class="line">ebp            0x0	0x0</div><div class="line">esi            0x0	0</div><div class="line">edi            0x0	0</div><div class="line">eip            0x7c3b	0x7c3b</div><div class="line">eflags         0x6	[ PF ]</div><div class="line">cs             0x8	8</div><div class="line">ss             0x10	16   &lt;-- 此时已经进入保护模式，这里选中第二个段描述符。</div><div class="line">ds             0x10	16</div><div class="line">es             0x10	16</div><div class="line">fs             0x0	0</div><div class="line">gs             0x0	0</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>选择第2个段描述符之后，接下来开始执行：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">mov    $<span class="number">0x7c00</span>,%esp  <span class="comment">// 源代码是mov $start, %esp。由于start是程序起始位置。而</span></div><div class="line">						    <span class="comment">// 程序是被加载到0x7c00处的。所以start=0x7c00。</span></div></pre></td></tr></table></figure>
<p>得到的结果如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) info reg</div><div class="line">eax            0x0	0</div><div class="line">ecx            0x0	0</div><div class="line">edx            0x80	128</div><div class="line">ebx            0x0	0</div><div class="line">esp            0x7c00	0x7c00   <span class="comment"># &lt;-- esp指向0x7c00。</span></div><div class="line">ebp            0x0	0x0</div><div class="line">esi            0x0	0</div><div class="line">edi            0x0	0</div><div class="line">eip            0x7c48	0x7c48</div><div class="line">eflags         0x6	[ PF ]</div><div class="line">cs             0x8	8</div><div class="line">ss             0x10	16</div><div class="line">ds             0x10	16</div><div class="line">es             0x10	16</div><div class="line">fs             0x0	0</div><div class="line">gs             0x0	0</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>如果不能<code>debug</code>，其实直接阅读<code>bootblock.asm</code>也可以看出如下代码：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment"># Set up the stack pointer and call into C.</span></div><div class="line">movl    <span class="variable">$start</span>, %esp</div><div class="line">  7c43:   bc 00 7c 00 00          mov    <span class="variable">$0x7c00</span>,%esp</div></pre></td></tr></table></figure>
<p>设置<code>%esp</code>结束之后，形成的结构如下所示：<br><img src="/blog/img/lab1.a/lab1.a.boot-up.mem.jpeg.001.jpeg.001.jpeg.002.jpeg" alt=""></p>
<h3 id="Q-2-3-必备小知识"><a href="#Q-2-3-必备小知识" class="headerlink" title="Q.2.3 必备小知识"></a>Q.2.3 必备小知识</h3><p>接下来的代码，就是准备调用<code>bootmain</code>程序了。</p>
<p><strong>摘取自bootblock.asm</strong><br><figure class="highlight c"><table><tr><td class="code"><pre><div class="line">call    bootmain</div><div class="line">  <span class="number">7</span>c48:   e8 e2 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">7</span>d2f &lt;bootmain&gt;</div></pre></td></tr></table></figure></p>
<p>这里是汇编程序调用C程序。因此，在执行<code>call bootmain</code>命令的时候，实际上是有以下动作。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">更加详细信息参考**赵炯《Linux内核完全剖析－linux.0.11》版本**第三章，3.4 C与汇编的相互调用。如果无心阅读，直接看下文也没有关系。</div></pre></td></tr></table></figure>
<p>这里可以看一下调用栈的结构。</p>
<p><img src="/blog/img/lab1.a/call.stack.jpeg" alt=""></p>
<p><strong>注意</strong><br>参数1，参数2，参数3，直到参数n都是给被调用者函数使用的。但是却是放于调用者的栈帧中。</p>
<h4 id="Q-2-3-1-栈与参数的传递"><a href="#Q-2-3-1-栈与参数的传递" class="headerlink" title="Q.2.3.1 栈与参数的传递"></a>Q.2.3.1 栈与参数的传递</h4><p>对照上图，需要特别注意的是：假设把调用者称为函数A，被调用者称为函数B。也就是形成如下结构。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">A</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c, <span class="keyword">int</span> d)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> arg1, arg2, arg3;</div><div class="line">	<span class="comment">//...</span></div><div class="line">	B(arg1, arg2, arg3);</div><div class="line">	<span class="comment">//...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">B</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> x;</div><div class="line">	<span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>调用者的栈帧：int arg1, arg2, arg3, 是存放在<code>局部变量区域</code>。</li>
<li><code>B(arg1, arg2, arg3)</code>在调用时，这些参数会被压入栈中。这个时候仍然是处在函数A的栈帧中。也就是对应到图中参数1,参数2,参数3`的地方。可以看到，入栈的时候，是从函数参数的尾部开始的，也就是位于最后的参数最先入栈。</li>
<li><code>函数B</code>通过<code>ebp+8, ebp+12</code>等等来访问变量<code>arg1, arg2</code>。这个时候<code>ebp</code>里面存放的是函数Ａ的<code>ebp</code>的值。</li>
<li>函数A也是通过<code>ebp</code>来访问函数参数。所以在调用<code>函数B</code>的时候，需要把<code>ebp</code>也入栈。</li>
<li>当进入到函数B之后，帧指针<code>ebp</code>指向的地址即<code>ebp+0</code>这里存放的实际上是<code>函数Ａ</code>使用的<code>ebp</code>。所以声明为<code>指向上一个</code>。</li>
<li>通过前面的总结可以得到：<code>ebp+8</code>就取到了第<code>1</code>个传入的函数参数。<code>ebp-n</code>，就是得到当前函数的内部的局部变量。比如<code>ebp-4</code>就得到局部变量<code>x</code>。</li>
</ul>
<p><strong>调用者函数Ａ的工作</strong></p>
<ul>
<li>把函数需要的参数压入栈中。</li>
<li>把返回地址压入栈中。</li>
<li>调用函数B。</li>
</ul>
<p><strong>被调用函数Ｂ的工作</strong></p>
<p>直接上代码就可以了。如果要更加详细的说明，请阅读<code>《汇编语言程序设计》Richard Blum的书的第11章，使用函数</code>。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">function:</div><div class="line">	pushl %ebp</div><div class="line">	movl %esp, %ebp</div><div class="line">	</div><div class="line">	...</div><div class="line">	</div><div class="line">	movl %ebp, %esp</div><div class="line">	popl %ebp</div><div class="line">	ret</div></pre></td></tr></table></figure>
<h4 id="Q-2-3-3-栈与局部变量"><a href="#Q-2-3-3-栈与局部变量" class="headerlink" title="Q.2.3.3 栈与局部变量"></a>Q.2.3.3 栈与局部变量</h4><p>在<code>函数B</code>内部处理的时候，局部变量处理方法如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">function:</div><div class="line">	pushl %ebp</div><div class="line">	movl %esp, %ebp</div><div class="line">	</div><div class="line">	<span class="comment">// for local variable.</span></div><div class="line">	subl $<span class="number">8</span>, %esp</div></pre></td></tr></table></figure>
<p>这里就保留了8字节的局部变量空间给<code>函数Ｂ</code>。</p>
<h4 id="Q-2-3-4-栈的清理工作"><a href="#Q-2-3-4-栈的清理工作" class="headerlink" title="Q.2.3.4 栈的清理工作"></a>Q.2.3.4 栈的清理工作</h4><p>当<code>函数B</code>使用<code>ret</code>指令返回之后，调用方因为压入了各种参数到栈中，还需要由调用方来清理栈里面的参数。方法很简单，参数占了多少个字节，直接修改<code>%esp</code>指针回去就可以了。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">pushl %eax</div><div class="line">pushl %ebx</div><div class="line">pushl %ecx</div><div class="line"></div><div class="line">call func_b</div><div class="line"></div><div class="line">addl $<span class="number">12</span>, %esp <span class="comment">//这里修改esp指针的位置。</span></div></pre></td></tr></table></figure>
<h3 id="Q-2-4-call-bootmain"><a href="#Q-2-4-call-bootmain" class="headerlink" title="Q.2.4 call bootmain"></a>Q.2.4 call bootmain</h3><p>有了<code>Q.2.3小知识</code>的学习，现在应该可以搞清楚函数调用的过程了。接下来，直接看调用方：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"># Set up the <span class="built_in">stack</span> pointer and call into C.</div><div class="line">movl    $start, %esp</div><div class="line">  <span class="number">7</span>c43:   bc <span class="number">00</span> <span class="number">7</span>c <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x7c00</span>,%esp</div><div class="line">call    bootmain</div><div class="line">  <span class="number">7</span>c48:   e8 e2 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">7</span>d2f &lt;bootmain&gt;</div></pre></td></tr></table></figure>
<p>这里实际上只做了两件事：</p>
<ul>
<li>设置栈顶指针，也就是栈是从哪里开始放数据的。</li>
<li><code>call bootmain</code>，在这里会把返回地址压入栈中。</li>
</ul>
<p>这里根据<code>gdb</code>调试器来进行验证。</p>
<p><strong>栈顶指针esp</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">(gdb) si</div><div class="line">=&gt; <span class="number">0x7c48</span>:	call   <span class="number">0x7d2f</span>  <span class="comment">// &lt;-- 这里指向了call bootmain，但是实际上还没有执行。刚执行完了mov $start, %esp</span></div><div class="line">                            <span class="comment">// &lt;-- 而$start的值，由于在编译的时候，Makefile里面写明了程序加载地址是从0x7c00开始。</span></div><div class="line">                            <span class="comment">// 所以$start的值就是0x7c00。</span></div><div class="line"><span class="number">0x00007c48</span> in ?? ()</div><div class="line">(gdb) info reg</div><div class="line">eax            <span class="number">0x0</span>	<span class="number">0</span></div><div class="line">ecx            <span class="number">0x0</span>	<span class="number">0</span></div><div class="line">edx            <span class="number">0x80</span>	<span class="number">128</span></div><div class="line">ebx            <span class="number">0x0</span>	<span class="number">0</span></div><div class="line">esp            <span class="number">0x7c00</span>	<span class="number">0x7c00</span>  &lt;---- %esp = <span class="number">0x7c00</span></div><div class="line">ebp            <span class="number">0x0</span>	<span class="number">0x0</span></div><div class="line">esi            <span class="number">0x0</span>	<span class="number">0</span></div><div class="line">edi            <span class="number">0x0</span>	<span class="number">0</span></div><div class="line">eip            <span class="number">0x7c48</span>	<span class="number">0x7c48</span></div><div class="line">eflags         <span class="number">0x6</span>	[ PF ]</div><div class="line">cs             <span class="number">0x8</span>	<span class="number">8</span></div><div class="line">ss             <span class="number">0x10</span>	<span class="number">16</span></div><div class="line">ds             <span class="number">0x10</span>	<span class="number">16</span></div><div class="line">es             <span class="number">0x10</span>	<span class="number">16</span></div><div class="line">fs             <span class="number">0x0</span>	<span class="number">0</span></div><div class="line">gs             <span class="number">0x0</span>	<span class="number">0</span></div></pre></td></tr></table></figure>
<p><strong>返回地址入栈</strong></p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">//代码如下：</div><div class="line">  # Set up the stack pointer and call into C.</div><div class="line">  movl    $start, %esp</div><div class="line">    7c43:   bc 00 7c 00 00          mov    $0x7c00,%esp</div><div class="line">  call    bootmain</div><div class="line">    7c48:   e8 e2 00 00 00          call   7d2f &lt;bootmain&gt;</div><div class="line"></div><div class="line">  # If bootmain returns (it shouldn't), trigger a Bochs</div><div class="line">  # breakpoint if running under Bochs, then loop.</div><div class="line">  movw    $0x8a00, %ax            # 0x8a00 -&gt; port 0x8a00</div><div class="line">    7c4d:   66 b8 00 8a             mov    $0x8a00,%ax</div></pre></td></tr></table></figure>
<p><img src="/blog/img/lab1.a/caller.start.address.jpeg" alt=""></p>
<p>调试结果：（GDB调试网页太多了，给个参考：(<a href="http://www.cnblogs.com/rosesmall/archive/2012/04/12/2444431.html)）" target="_blank" rel="external">http://www.cnblogs.com/rosesmall/archive/2012/04/12/2444431.html)）</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">(gdb) si</div><div class="line">=&gt; <span class="number">0x7d2f</span>:	push   %ebp &lt;-- 注意：这句话已经位于bootmain函数中，但是还没有执行。后面的结果都是刚运行</div><div class="line">							  <span class="comment">// &lt;-- call bootmain之后的结果。</span></div><div class="line"><span class="number">0x00007d2f</span> in ?? ()</div><div class="line">(gdb) info reg</div><div class="line">esp            <span class="number">0x7bfc</span>	<span class="number">0x7bfc</span></div><div class="line">ebp            <span class="number">0x0</span>	<span class="number">0x0</span></div><div class="line">ss             <span class="number">0x10</span>	<span class="number">16</span></div></pre></td></tr></table></figure>
<p>栈中的内容：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">(gdb) x/<span class="number">1</span>x $esp</div><div class="line"><span class="number">0x7bfc</span>:	<span class="number">0x00007c4d</span></div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p><code>gdb</code>中的<code>x</code>指令表示的是：从指定的地址处，取出多长的内容，并打印出来。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 打印格式 x/n&#123;print_format&#125; $address</span></div><div class="line"><span class="comment">// print_format有如下选项</span></div><div class="line">x 按十六进制格式显示变量。</div><div class="line">d 按十进制格式显示变量。</div><div class="line">u 按十六进制格式显示无符号整型。</div><div class="line">o 按八进制格式显示变量。</div><div class="line">t 按二进制格式显示变量。</div><div class="line">a 按十六进制格式显示变量。</div><div class="line">c 按字符格式显示变量。</div><div class="line">f 按浮点数格式显示变量。</div></pre></td></tr></table></figure>
<p>指令的完整含义：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">x/&lt;n/f/u&gt; &lt;addr&gt;</div><div class="line"><span class="comment">/*</span></div><div class="line">n、f、u是可选的参数。</div><div class="line"></div><div class="line">n是一个正整数，表示需要显示的内存单元的个数，也就是说从当前地址向后显示几个内存单元的内容，一个内存单元的大小由后面的u定义。</div><div class="line"></div><div class="line">f 表示显示的格式，参见下面。如果地址所指的是字符串，那么格式可以是s，如果地十是指令地址，那么格式可以是i。</div><div class="line"></div><div class="line">u 表示从当前地址往后请求的字节数，如果不指定的话，GDB默认是4个bytes。u参数可以用下面的字符来代替，b表示单字节，h表示双字节，w表示四字 节，g表示八字节。当我们指定了字节长度后，GDB会从指内存定的内存地址开始，读写指定字节，并把其当作一个值取出来。</div><div class="line"></div><div class="line">&lt;addr&gt;表示一个内存地址。</div><div class="line">*/</div></pre></td></tr></table></figure>
<p><strong>查看栈中内容的方法</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">(gdb) x/<span class="number">1</span>x <span class="number">0x7c00</span><span class="number">-0x4</span></div><div class="line"><span class="number">0x7bfc</span>:	<span class="number">0x00007c4d</span>    &lt;-- 已经入栈的第一个元素，里面存放了返回地址。</div><div class="line">(gdb) x/<span class="number">1</span>x <span class="number">0x7c00</span><span class="number">-0x8</span></div><div class="line"><span class="number">0x7bf8</span>:	<span class="number">0x00000000</span>    &lt;-- 栈中后面可用空间，内容不定，但是在这里都显示为<span class="number">0.</span></div><div class="line">(gdb) x/<span class="number">1</span>x <span class="number">0x7c00</span><span class="number">-0xc</span></div><div class="line"><span class="number">0x7bf4</span>:	<span class="number">0x00000000</span></div></pre></td></tr></table></figure>
<p><strong>esp与入栈</strong></p>
<ul>
<li>esp -= 4;</li>
<li>[esp] = var</li>
</ul>
<p>也就是说，先把<code>%esp</code>减4,然后再把内容放进去。</p>
<h2 id="问题3-bootmain的栈操作"><a href="#问题3-bootmain的栈操作" class="headerlink" title="问题3 bootmain的栈操作"></a>问题3 bootmain的栈操作</h2><p>原问题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">What do the first assembly instructions of bootmain do to the stack? Look for bootmain in bootblock.asm.</div></pre></td></tr></table></figure>
<p>如<code>Q.2.3小知识</code>中所述，<code>bootmain</code>中就开始对<code>%ebp, %esp</code>进行处理。处理的框架就是：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">function:</div><div class="line">	pushl %ebp</div><div class="line">	movl %esp, %ebp</div><div class="line">	</div><div class="line">	<span class="comment">//..</span></div><div class="line">	处理局部变量！</div><div class="line">	...</div><div class="line">	</div><div class="line">	movl %ebp, %esp</div><div class="line">	popl %ebp</div><div class="line">	ret</div></pre></td></tr></table></figure>
<p>所以，<code>bootblock.asm</code>中<code>bootmain</code>中的代码如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"># Set up the <span class="built_in">stack</span> pointer and call into C.</div><div class="line">movl    $start, %esp</div><div class="line">    <span class="number">7</span>c43:   bc <span class="number">00</span> <span class="number">7</span>c <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x7c00</span>,%esp</div><div class="line">call    bootmain</div><div class="line">    <span class="number">7</span>c48:   e8 e2 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">7</span>d2f &lt;bootmain&gt;</div><div class="line"></div><div class="line">....</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">bootmain</span><span class="params">(<span class="keyword">void</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="number">7</span>d2f:   <span class="number">55</span>                      push   %ebp</div><div class="line">    <span class="number">7</span>d30:   <span class="number">89</span> e5                   mov    %esp,%ebp</div></pre></td></tr></table></figure>
<p>注意<code>call bootmain</code>指令生成的结果就是<code>call 7d2f</code>。而在<code>bootmain</code>中第一条指令的位置就是<code>7d2f</code>。并且进入函数之后，第一件事就是按照Ｃ语言的函数处理方式来压栈。<code>gdb</code>调试如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 执行 push %ebp之后的调试结果</span></div><div class="line">(gdb) info reg</div><div class="line">esp            <span class="number">0x7bf8</span>	<span class="number">0x7bf8</span></div><div class="line">ebp            <span class="number">0x0</span>	<span class="number">0x0</span></div><div class="line">......</div><div class="line">ss             <span class="number">0x10</span>	<span class="number">16</span></div><div class="line"></div><div class="line">(gdb) x/<span class="number">1</span>x <span class="number">0x7c00</span><span class="number">-4</span></div><div class="line"><span class="number">0x7bfc</span>:	<span class="number">0x00007c4d</span> &lt;-- 已经入栈的函数的返回地址，由汇编代码负责。</div><div class="line">(gdb) x/<span class="number">1</span>x <span class="number">0x7c00</span><span class="number">-8</span></div><div class="line"><span class="number">0x7bf8</span>:	<span class="number">0x00000000</span> &lt;-- bootmain C程序负责的压入的%ebp的值。</div><div class="line">(gdb)</div><div class="line"></div><div class="line">(gdb) si &lt; -- 这里执行 mov %esp,%ebp</div><div class="line"></div><div class="line">(gdb) info reg</div><div class="line">esp            <span class="number">0x7bf8</span>	<span class="number">0x7bf8</span>  &lt;-- 执行完成之后，可以看到%ebp记录了当前%esp的值。</div><div class="line">ebp            <span class="number">0x7bf8</span>	<span class="number">0x7bf8</span></div><div class="line">ss             <span class="number">0x10</span>	<span class="number">16</span></div><div class="line">(gdb)</div><div class="line"></div><div class="line">(gdb) x/<span class="number">1</span>x $ebp</div><div class="line"><span class="number">0x7bf8</span>:	<span class="number">0x00000000</span>   &lt;-- %ebp中对应地址里面存放的内容是：汇编程序里面用到的%ebp的值。</div><div class="line"></div><div class="line"><span class="number">7</span>d35:   <span class="number">83</span> ec <span class="number">1</span>c                sub    $<span class="number">0x1c</span>,%esp &lt;-- 这里就是bootmain开始处理内部的局部变量了。</div></pre></td></tr></table></figure>
<h2 id="问题4"><a href="#问题4" class="headerlink" title="问题4"></a>问题4</h2><p>原问题</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Continue tracing via gdb (using breakpoints if necessary -- see hint below) </div><div class="line">and look for the call that changes eip to 0x10000c. What does that call do </div><div class="line">to the stack? (Hint: Think about what this call is trying to accomplish in </div><div class="line">the boot sequence and try to identify this point in bootmain.c, and the </div><div class="line">corresponding instruction in the bootmain code in bootblock.asm. This </div><div class="line">might help you set suitable breakpoints to speed things up.)</div></pre></td></tr></table></figure>
<p>注意：编译之后的结果显示的指令是：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">=&gt; <span class="number">0x7db1</span>:	call   *<span class="number">0x10018</span></div></pre></td></tr></table></figure>
<p>但是在<code>gdb/si</code>单步执行的时候，显示的是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">(gdb) si</div><div class="line">=&gt; 0x10000c:	mov    %cr4,%eax</div><div class="line">0x0010000c in ?? ()</div></pre></td></tr></table></figure>
<p>也就是说的确进入到了<code>0x10000c</code>地址执行。这里是因为，<code>call</code>的时候，跳转地址是从内存<code>0x10018</code>处取出来的，因为<code>call后面的地址，前面有个*号</code>。可以利用<code>gdb</code>查看如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">(gdb) x/<span class="number">1</span>x <span class="number">0x10018</span></div><div class="line"><span class="number">0x10018</span>:	<span class="number">0x0010000c</span></div></pre></td></tr></table></figure>
<p>实际上<code>bootmain.c</code>主要做的事情就是读取<code>kernel</code>，并且跳转到<code>kernel</code>处开始执行。加载的时候，是把<code>kernel</code>加载到了<code>0x10000</code>内存地址处。</p>
<p>那么回到问题，就是说对栈做了些什么，实际上这里还是应该说只是把返回地址压栈了。这里查看<code>bootblock.asm</code>的代码；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">  <span class="comment">// Call the entry point from the ELF header.</span></div><div class="line">  <span class="comment">// Does not return!</span></div><div class="line">  entry = (<span class="keyword">void</span>(*)(<span class="keyword">void</span>))(elf-&gt;entry);</div><div class="line">  entry();</div><div class="line">    <span class="number">7</span>db1:   ff <span class="number">15</span> <span class="number">18</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span>       call   *<span class="number">0x10018</span></div><div class="line">&#125;</div><div class="line">    <span class="number">7</span>db7:   <span class="number">83</span> c4 <span class="number">1</span>c                add    $<span class="number">0x1c</span>,%esp</div></pre></td></tr></table></figure>
<p>可以看到返回地址是<code>7db7</code>，那么再查看一下内存里面的内容：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">(gdb) x/<span class="number">1</span>x <span class="number">0x7bcc</span></div><div class="line"><span class="number">0x7bcc</span>:	<span class="number">0x00007db7</span></div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>后面的事情就是完全交给<code>kernel</code>了。不过感觉有点没有照着C的规范来。也就是开始并不是：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><div class="line">function:</div><div class="line">	pushl %ebp</div><div class="line">	movl %esp, %ebp</div><div class="line">	</div><div class="line">	<span class="comment">//..</span></div><div class="line">	处理局部变量！</div><div class="line">	...</div><div class="line">	</div><div class="line">	movl %ebp, %esp</div><div class="line">	popl %ebp</div><div class="line">	ret</div></pre></td></tr></table></figure>
<p>这里面可能的一个原因是：控制权完全给kernel之后，后面kernel会重新接管内存什么的。再接着看后面的内容吧。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JOS/">JOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/MIT-6-828/">MIT 6.828</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/blog/categories/xv6/">xv6</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-jos-lab1-a" data-title="MIT 6.828 JOS课程1：HW Boot xv6" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/16/hello-world/" class="article-date">
  	<time datetime="2016-09-15T23:25:09.000Z" itemprop="datePublished">2016-09-16</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/16/hello-world/">Mac上搭建Hexo+Github博客</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这篇博客主要是介绍如何在Mac上搭建<code>Hexo+Github</code>博客。</p>
<p><strong>其实最重要的还是认真读文档</strong></p>
<ul>
<li><a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="external">https://hexo.io/zh-cn/docs/</a></li>
</ul>
<p>使用Hexo的好处。</p>
<ul>
<li>可以使用Markdown来写作。</li>
<li>格式非常好看。</li>
<li>支持博客的分类以及评论。</li>
</ul>
<h1 id="Mac安装NodeJS"><a href="#Mac安装NodeJS" class="headerlink" title="Mac安装NodeJS"></a>Mac安装NodeJS</h1><p>到<a href="https://nodejs.org/en/download/" target="_blank" rel="external">网站</a>下载对应操作系统的安装包：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">https://nodejs.org/en/download/</div></pre></td></tr></table></figure>
<p>我这里是<code>Mac</code>操作系统，所以下载的是<code>Mac</code>的安装包。</p>
<h1 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h1><p>安装完成<code>nodejs</code>之后，开始安装<code>Hexo</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">sudo npm install -g hexo</div></pre></td></tr></table></figure>
<h1 id="懒人包"><a href="#懒人包" class="headerlink" title="懒人包"></a>懒人包</h1><p>其实大多数时候，我们都只是希望找到一个框架怎么用？懒得去一步一步配置，那么这个时候。<br>如果有个参考的可以进行配置，应该就很爽了。</p>
<p>所以，我把我的所有的配置都放在一个github上。当安装好npm和hexo之后，就可以直接使用了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">https://github.com/JiYou/blogtemplate.git</div></pre></td></tr></table></figure>
<p>使用的时候，先<code>clone</code>下来，然后再运行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">hexo g</div><div class="line">hexo s</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 添加图片的时候，在Markdown里需要做两步：</span></div><div class="line">1. 把图片放在<span class="built_in">source</span>/img/目录下</div><div class="line">2. 在文章的md文件中设置图片目录为![](/blog/img/image.name.png)</div></pre></td></tr></table></figure>
<p>就可以了(后面的内容就可以不用看了)。OVER</p>
<p>这里要注意使用<code>sudo</code>，这是因为在安装的时候，需要添加一些<code>lib</code>库。</p>
<h1 id="第一个博客"><a href="#第一个博客" class="headerlink" title="第一个博客"></a>第一个博客</h1><p>开始生成第一个博客：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">sudo hexo init blog</div></pre></td></tr></table></figure>
<p>这里也会下载一些包来安装，所以尽量使用sudo。</p>
<h1 id="安装theme"><a href="#安装theme" class="headerlink" title="安装theme"></a>安装theme</h1><p>这里是我觉得比较好看的一个风格。安装方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> blog</div><div class="line">git <span class="built_in">clone</span> https://github.com/litten/hexo-theme-yilia.git themes/yilia</div></pre></td></tr></table></figure>
<h1 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h1><p>把<code>blog/_config.yml</code>配置文件修改成如下内容：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><div class="line"><span class="comment"># Hexo Configuration</span></div><div class="line"><span class="comment">## Docs: https://hexo.io/docs/configuration.html</span></div><div class="line"><span class="comment">## Source: https://github.com/hexojs/hexo/</span></div><div class="line"></div><div class="line"><span class="comment"># Site</span></div><div class="line"><span class="attr">title:</span> 缘生故如幻</div><div class="line"><span class="attr">subtitle:</span> 心言直故，如是乃至始终地位，中间永无诸委曲相。</div><div class="line"><span class="attr">description:</span> 记录一切有意思的事。</div><div class="line"><span class="attr">author:</span> You Ji</div><div class="line"><span class="attr">language:</span></div><div class="line"><span class="attr">timezone:</span></div><div class="line"></div><div class="line"><span class="comment"># URL</span></div><div class="line"><span class="comment">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span></div><div class="line"><span class="attr">url:</span> http://jiyou.github.io/blog</div><div class="line"><span class="attr">root:</span> /blog/</div><div class="line"><span class="attr">permalink:</span> :year/:month/:day/:title/</div><div class="line"><span class="attr">permalink_defaults:</span></div><div class="line"></div><div class="line"><span class="comment"># Directory</span></div><div class="line"><span class="attr">source_dir:</span> source</div><div class="line"><span class="attr">public_dir:</span> public</div><div class="line"><span class="attr">tag_dir:</span> tags</div><div class="line"><span class="attr">archive_dir:</span> archives</div><div class="line"><span class="attr">category_dir:</span> categories</div><div class="line"><span class="attr">code_dir:</span> downloads/code</div><div class="line"><span class="attr">i18n_dir:</span> :lang</div><div class="line"><span class="attr">skip_render:</span></div><div class="line"></div><div class="line"><span class="comment"># Writing</span></div><div class="line"><span class="attr">new_post_name:</span> :title.md <span class="comment"># File name of new posts</span></div><div class="line"><span class="attr">default_layout:</span> post</div><div class="line"><span class="attr">titlecase:</span> <span class="literal">false</span> <span class="comment"># Transform title into titlecase</span></div><div class="line"><span class="attr">external_link:</span> <span class="literal">true</span> <span class="comment"># Open external links in new tab</span></div><div class="line"><span class="attr">filename_case:</span> <span class="number">0</span></div><div class="line"><span class="attr">render_drafts:</span> <span class="literal">false</span></div><div class="line"><span class="attr">post_asset_folder:</span> <span class="literal">false</span></div><div class="line"><span class="attr">relative_link:</span> <span class="literal">false</span></div><div class="line"><span class="attr">future:</span> <span class="literal">true</span></div><div class="line"><span class="attr">highlight:</span></div><div class="line"><span class="attr">  enable:</span> <span class="literal">true</span></div><div class="line"><span class="attr">  line_number:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  auto_detect:</span> <span class="literal">false</span></div><div class="line"><span class="attr">  tab_replace:</span></div><div class="line"></div><div class="line"><span class="comment"># Category &amp; Tag</span></div><div class="line"><span class="attr">default_category:</span> 随笔</div><div class="line"><span class="attr">categories:</span></div><div class="line"><span class="bullet">  -</span> 随笔</div><div class="line"><span class="bullet">  -</span> xv6</div><div class="line"><span class="bullet">  -</span> mit<span class="number">.6</span><span class="number">.828</span></div><div class="line"><span class="attr">category_map:</span></div><div class="line"><span class="bullet">  -</span> 随笔: blog</div><div class="line"><span class="attr">  - xv6:</span> xv6</div><div class="line"><span class="bullet">  -</span> mit<span class="number">.6</span><span class="number">.828</span>: jos</div><div class="line"><span class="attr">tag_map:</span></div><div class="line"></div><div class="line"><span class="comment"># Date / Time format</span></div><div class="line"><span class="comment">## Hexo uses Moment.js to parse and display date</span></div><div class="line"><span class="comment">## You can customize the date format as defined in</span></div><div class="line"><span class="comment">## http://momentjs.com/docs/#/displaying/format/</span></div><div class="line"><span class="attr">date_format:</span> YYYY-MM-DD</div><div class="line"><span class="attr">time_format:</span> HH:mm:ss</div><div class="line"></div><div class="line"><span class="comment"># Pagination</span></div><div class="line"><span class="comment">## Set per_page to 0 to disable pagination</span></div><div class="line"><span class="attr">per_page:</span> <span class="number">10</span></div><div class="line"><span class="attr">pagination_dir:</span> page</div><div class="line"></div><div class="line"><span class="comment"># Extensions</span></div><div class="line"><span class="comment">## Plugins: https://hexo.io/plugins/</span></div><div class="line"><span class="comment">## Themes: https://hexo.io/themes/</span></div><div class="line"><span class="attr">theme:</span> yilia</div><div class="line"></div><div class="line"><span class="comment"># Deployment</span></div><div class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></div><div class="line"><span class="attr">deploy:</span></div><div class="line"><span class="attr">    type:</span> git</div><div class="line"><span class="attr">    repository:</span> git@github.com:JiYou/blog.git</div><div class="line"><span class="attr">    branch:</span> master</div></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<p>这里面最重要的是需要设置正确的<code>URL</code>：</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><div class="line"><span class="comment"># URL</span></div><div class="line"><span class="comment">## If your site is put in a subdirectory, set url as 'http://yoursite.com/child' and root as '/child/'</span></div><div class="line"><span class="attr">url:</span> http://jiyou.github.io/blog</div><div class="line"><span class="attr">root:</span> /blog/</div></pre></td></tr></table></figure>
<p>这里需要注意设置好正确的<code>root URL</code>,否则效果出不来。</p>
<h1 id="设置分类"><a href="#设置分类" class="headerlink" title="设置分类"></a>设置分类</h1><p>设置分类的时候，需要修改theme包里面的<code>_config.yml</code>文件。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><div class="line"><span class="comment"># Header</span></div><div class="line"><span class="attr">menu:</span></div><div class="line">  主页: /</div><div class="line">  所有文章: /archives</div><div class="line">  随笔: /categories/随笔</div><div class="line"></div><div class="line"><span class="comment"># SubNav</span></div><div class="line"><span class="attr">subnav:</span></div><div class="line"><span class="attr">  github:</span> <span class="string">"#"</span></div><div class="line"><span class="attr">  weibo:</span> <span class="string">"#"</span></div><div class="line"><span class="attr">  rss:</span> <span class="string">"#"</span></div><div class="line"><span class="attr">  zhihu:</span> <span class="string">"#"</span></div><div class="line">  <span class="comment">#douban: "#"</span></div><div class="line">  <span class="comment">#mail: "#"</span></div><div class="line">  <span class="comment">#facebook: "#"</span></div><div class="line">  <span class="comment">#google: "#"</span></div><div class="line">  <span class="comment">#twitter: "#"</span></div><div class="line">  <span class="comment">#linkedin: "#"</span></div><div class="line"></div><div class="line"><span class="attr">rss:</span> /atom.xml</div><div class="line"></div><div class="line"><span class="comment"># 是否需要修改 root 路径</span></div><div class="line"><span class="comment"># 如果您的网站存放在子目录中，例如 http://yoursite.com/blog，</span></div><div class="line"><span class="comment"># 请将您的 url 设为 http://yoursite.com/blog 并把 root 设为 /blog/。</span></div><div class="line"><span class="attr">rul:</span> https://jiyou.github.io/blog</div><div class="line"><span class="attr">root:</span> /blog/</div><div class="line"></div><div class="line"><span class="comment"># Content</span></div><div class="line"><span class="attr">excerpt_link:</span> more</div><div class="line"><span class="attr">fancybox:</span> <span class="literal">true</span></div><div class="line"><span class="attr">mathjax:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># 是否开启动画效果</span></div><div class="line"><span class="attr">animate:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># 是否在新窗口打开链接</span></div><div class="line"><span class="attr">open_in_new:</span> <span class="literal">false</span></div><div class="line"></div><div class="line"><span class="comment"># Miscellaneous</span></div><div class="line"><span class="attr">google_analytics:</span> <span class="string">''</span></div><div class="line"><span class="attr">favicon:</span> /favicon.png</div><div class="line"></div><div class="line"><span class="comment">#你的头像url</span></div><div class="line"><span class="attr">avatar:</span></div><div class="line"><span class="comment">#是否开启分享</span></div><div class="line"><span class="attr">share_jia:</span> <span class="literal">true</span></div><div class="line"><span class="attr">share_addthis:</span> <span class="literal">false</span></div><div class="line"><span class="comment">#是否开启多说评论，填写你在多说申请的项目名称 duoshuo: duoshuo-key</span></div><div class="line"><span class="comment">#若使用disqus，请在博客config文件中填写disqus_shortname，并关闭多说评论</span></div><div class="line"><span class="attr">duoshuo:</span> <span class="literal">true</span></div><div class="line"><span class="comment">#是否开启云标签</span></div><div class="line"><span class="attr">tagcloud:</span> <span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment">#是否开启友情链接</span></div><div class="line"><span class="comment">#不开启——</span></div><div class="line"><span class="comment">#friends: false</span></div><div class="line"><span class="comment">#开启——</span></div><div class="line"><span class="comment">#friends: true</span></div><div class="line"><span class="comment">#  奥巴马的博客: http://localhost:4000/</span></div><div class="line"><span class="comment">#  托蒂的博客: http://localhost:4000/</span></div><div class="line"></div><div class="line"><span class="comment">#是否开启“关于我”。</span></div><div class="line"><span class="comment">#不开启——</span></div><div class="line"><span class="comment">#aboutme: false</span></div><div class="line"><span class="comment">#开启——</span></div><div class="line"><span class="attr">aboutme:</span> 我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div></pre></td></tr></table></figure>
<h1 id="博客的类别"><a href="#博客的类别" class="headerlink" title="博客的类别"></a>博客的类别</h1><p>把博客的类别修改成如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(osclient)youji@LM-SHC-00950776:~/Documents/code/codelife$ cat <span class="built_in">source</span>/_posts/hello-world.md</div><div class="line">---</div><div class="line">title: Mac上搭建Hexo+Github博客</div><div class="line">categories: 随笔</div><div class="line">---</div></pre></td></tr></table></figure>
<p>注意这里的<code>categories</code>需要与<code>blog/_config.yml</code>以及theme包里面的<code>themes/yilia/_config.yml</code>进行统一。</p>
<h1 id="评论"><a href="#评论" class="headerlink" title="评论"></a>评论</h1><p>参考<a href="http://www.jianshu.com/p/a4b74cc9ff28" target="_blank" rel="external">链接</a>设置评论。</p>
<h2 id="第一步：创建站点"><a href="#第一步：创建站点" class="headerlink" title="第一步：创建站点"></a>第一步：创建站点</h2><p><img src="/blog/img/duoshuo.png" alt=""></p>
<h2 id="第二步：修改短名"><a href="#第二步：修改短名" class="headerlink" title="第二步：修改短名"></a>第二步：修改短名</h2><figure class="highlight yml"><table><tr><td class="code"><pre><div class="line"><span class="comment">#是否开启多说评论，填写你在多说申请的项目名称 duoshuo: duoshuo-key</span></div><div class="line"><span class="comment">#若使用disqus，请在博客config文件中填写disqus_shortname，并关闭多说评论</span></div><div class="line"><span class="attr">duoshuo:</span> bloggithub</div><div class="line"><span class="comment">#是否开启云标签</span></div><div class="line"><span class="attr">tagcloud:</span> <span class="literal">true</span></div></pre></td></tr></table></figure>
<p>注意名字与前面图片进行对应。</p>
<h1 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h1><p>可能过<code>git diff</code>查看到我所有的更改。然后把<code>blog/_config.yml</code>里面的linenumber改成false。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"></div><div class="line">diff --git a/<span class="built_in">source</span>/css/_partial/highlight.styl b/<span class="built_in">source</span>/css/_partial/highlight.styl</div><div class="line">index 2de0c6c..574a3f4 100644</div><div class="line">--- a/<span class="built_in">source</span>/css/_partial/highlight.styl</div><div class="line">+++ b/<span class="built_in">source</span>/css/_partial/highlight.styl</div><div class="line">@@ -65,7 +65,6 @@ <span class="variable">$line</span>-numbers</div><div class="line">         text-shadow: none</div><div class="line">     .line</div><div class="line">       font-size: 15px</div><div class="line">-      height: 15px</div><div class="line">   .gist</div><div class="line">     margin: 0 article-padding * -1</div><div class="line">     border-style: solid</div></pre></td></tr></table></figure>
<h2 id="测试一下代码块"><a href="#测试一下代码块" class="headerlink" title="测试一下代码块"></a>测试一下代码块</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line">    <span class="built_in">printf</span> (<span class="string">"Hello world!\n"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/blog/categories/随笔/">随笔</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-hello-world" data-title="Mac上搭建Hexo+Github博客" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
    <article id="post-jos-lab1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/blog/2016/09/15/jos-lab1/" class="article-date">
  	<time datetime="2016-09-15T14:48:53.000Z" itemprop="datePublished">2016-09-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2016/09/15/jos-lab1/">MIT 6.828 JOS课程1：搭建实验环境</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="课程进度"><a href="#课程进度" class="headerlink" title="课程进度"></a>课程进度</h1><ul>
<li><a href="https://pdos.csail.mit.edu/6.828/2016/schedule.html" target="_blank" rel="external">https://pdos.csail.mit.edu/6.828/2016/schedule.html</a></li>
</ul>
<h1 id="三次作业"><a href="#三次作业" class="headerlink" title="三次作业"></a>三次作业</h1><ul>
<li>Assignment: HW: Boot xv6</li>
<li>Assignment: HW: shell</li>
<li>Assignment: Lab 1: C, Assembly, Tools, and Bootstrapping</li>
</ul>
<h1 id="Boot-xv6"><a href="#Boot-xv6" class="headerlink" title="Boot xv6"></a>Boot xv6</h1><p>这里只介绍第一次作业的情况，后面章节再介绍第一课的后面的作业。</p>
<ul>
<li>实验环境<code>Ubuntu:14.04</code></li>
<li>xv6 &amp; qemu</li>
</ul>
<h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><p>首先运行<code>apt-get update</code>升级系统包，然后再安装必须的一些包。比如：</p>
<p><strong>注意</strong>:<br>这里为了省事，都是使用的是<code>root</code>用户在操作。普通用户可以通过<code>sudo -s</code>切换到<code>root</code>用户。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 安装git</span></div><div class="line">apt-get install -y git</div><div class="line"></div><div class="line"><span class="comment"># 安装qemu</span></div><div class="line">apt-get install -y qemu-kvm</div><div class="line"></div><div class="line"><span class="comment"># 安装gdb</span></div><div class="line">apt-get install -y gdb</div><div class="line"></div><div class="line"><span class="comment"># 安装编译工具链</span></div><div class="line">apt-get install -y build-essential</div><div class="line"></div><div class="line"><span class="comment"># 下载xv6的代码</span></div><div class="line"><span class="built_in">cd</span> /opt/</div><div class="line">git <span class="built_in">clone</span> git://github.com/mit-pdos/xv6-public.git</div></pre></td></tr></table></figure>
<h2 id="编译xv6"><a href="#编译xv6" class="headerlink" title="编译xv6"></a>编译xv6</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /opt/</div><div class="line"><span class="built_in">cd</span> xv6-public</div><div class="line">make</div></pre></td></tr></table></figure>
<h2 id="运行gdb"><a href="#运行gdb" class="headerlink" title="运行gdb"></a>运行gdb</h2><p>这里需要开两个termial，一个用来运行qemu进程作为gdb-server，另外一个用来作为gdb调试端。</p>
<p><strong>qemu/gdb-server</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> /opt/xv6-public</div><div class="line">root@7c8d7a387d68:/opt/xv6-public<span class="comment"># make qemu-nox-gdb</span></div><div class="line">sed <span class="string">"s/localhost:1234/localhost:25000/"</span> &lt; .gdbinit.tmpl &gt; .gdbinit</div><div class="line">*** Now run <span class="string">'gdb'</span>.</div><div class="line">qemu-system-i386 -nographic -drive file=fs.img,index=1,media=disk,format=raw -drive file=xv6.img,index=0,media=disk,format=raw -smp 2 -m 512  -S -gdb tcp::25000</div></pre></td></tr></table></figure></p>
<p><strong>gdb-client</strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cd /opt/xv6-public</div><div class="line">root@7c8d7a387d68:/opt/xv6-public# gdb</div><div class="line">GNU gdb (Ubuntu 7.7.1-0ubuntu5~14.04.2) 7.7.1</div><div class="line">Copyright (C) 2014 Free Software Foundation, Inc.</div><div class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</div><div class="line">This is free software: you are free to change and redistribute it.</div><div class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</div><div class="line">and &quot;show warranty&quot; for details.</div><div class="line">This GDB was configured as &quot;x86_64-linux-gnu&quot;.</div><div class="line">Type &quot;show configuration&quot; for configuration details.</div><div class="line">For bug reporting instructions, please see:</div><div class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</div><div class="line">Find the GDB manual and other documentation resources online at:</div><div class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</div><div class="line">For help, type &quot;help&quot;.</div><div class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;.</div><div class="line">warning: File &quot;/opt/xv6-public/.gdbinit&quot; auto-loading has been declined by your `auto-load safe-path&apos; set to &quot;$debugdir:$datadir/auto-load&quot;.</div><div class="line">To enable execution of this file add</div><div class="line">	add-auto-load-safe-path /opt/xv6-public/.gdbinit</div><div class="line">line to your configuration file &quot;/home/youji/.gdbinit&quot;.</div><div class="line">To completely disable this security protection add</div><div class="line">	set auto-load safe-path /</div><div class="line">line to your configuration file &quot;/home/youji/.gdbinit&quot;.</div><div class="line">For more information about this security protection see the</div><div class="line">&quot;Auto-loading safe path&quot; section in the GDB manual.  E.g., run from the shell:</div><div class="line">	info &quot;(gdb)Auto-loading safe path&quot;</div><div class="line">(gdb)</div></pre></td></tr></table></figure></p>
<p>这里gdb有很长的一段输出，这里要特别注意，这里提示说需要添加一行内容到<code>.gdbinit</code>文件中去。</p>
<p><img src="/blog/img/gdb-settings.jpeg" alt=""></p>
<p>因此，这里需要参考红色框中的指令完成相应的设置：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mkdir -p /home/youji/</div><div class="line"><span class="built_in">echo</span> <span class="string">"add-auto-load-safe-path /opt/xv6-public/.gdbinit"</span> &gt;&gt; /home/youji/.gdbinit</div></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<ul>
<li>这里需要将<code>youji</code>改成自己的用户名。</li>
<li>运行gdb的时候，一定要在<code>/opt/xv6-public</code>目录下。</li>
</ul>
<p>运行成功之后，可以得到如下输出：</p>
<p><img src="/blog/img/gdb-setting-ok.jpeg" alt=""></p>
<p>注意汇编指令。</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>到这里开始，就已经可以调试了。先进行简单的调试。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) br * 0x7c00    &lt;-- 在0x7c00处设置一个断点。</div><div class="line">Breakpoint 1 at 0x7c00</div><div class="line">(gdb) c              &lt;-- 让程序开始运行</div><div class="line">Continuing.</div><div class="line">[   0:7c00] =&gt; 0x7c00:	cli</div></pre></td></tr></table></figure>
<p><strong>备注</strong></p>
<ul>
<li>在开始做JOS的实验之前，最好是可以读一下<strong>李忠</strong>的《x86汇编语言－从实模式到保护模式》这本书。否则汇编部分的代码看起来会比较累。</li>
</ul>
<h2 id="查看寄存器"><a href="#查看寄存器" class="headerlink" title="查看寄存器"></a>查看寄存器</h2><p>当程序运行到<code>0x7c00</code>处之后，就开始进入到<code>xv6</code>的汇编代部分了。可以利用如下命令查看寄存器。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) info reg</div><div class="line">eax            0xaa55	43605</div><div class="line">ecx            0x0	0</div><div class="line">edx            0x80	128</div><div class="line">ebx            0x0	0</div><div class="line">esp            0x6f2c	0x6f2c</div><div class="line">ebp            0x0	0x0</div><div class="line">esi            0x0	0</div><div class="line">edi            0x0	0</div><div class="line">eip            0x7c00	0x7c00</div><div class="line">eflags         0x202	[ IF ]</div><div class="line">cs             0x0	0</div><div class="line">ss             0x0	0</div><div class="line">ds             0x0	0</div><div class="line">es             0x0	0</div><div class="line">fs             0x0	0</div><div class="line">gs             0x0	0</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>可以看到，刚进入启动阶段的时候，cs:eip的值分别为：0:0x7c00。注意，这个时候还是处在实模式下。</p>
<h2 id="单步执行"><a href="#单步执行" class="headerlink" title="单步执行"></a>单步执行</h2><p>接下来就是可以单步执行了。由于在调试的时候，现在正在调试汇编语言，所以单步执行的命令会有所不同。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">(gdb) si  &lt;-- 输入si表示单步指令，接下来会输出即将要执行（但是还不会执行的指令）</div><div class="line">[   0:7c01] =&gt; 0x7c01:	xor    %ax,%ax  &lt;-- ax = 0</div><div class="line">0x00007c01 <span class="keyword">in</span> ?? ()</div><div class="line">(gdb) info reg</div><div class="line">eax            0xaa55	43605  &lt;-- 由于si并不会执行输出的指令，所以这里值还没有变成0.</div><div class="line">ecx            0x0	0</div><div class="line">edx            0x80	128</div><div class="line">ebx            0x0	0</div><div class="line">esp            0x6f2c	0x6f2c</div><div class="line">ebp            0x0	0x0</div><div class="line">esi            0x0	0</div><div class="line">edi            0x0	0</div><div class="line">eip            0x7c01	0x7c01</div><div class="line">eflags         0x2	[ ]</div><div class="line">cs             0x0	0</div><div class="line">ss             0x0	0</div><div class="line">ds             0x0	0</div><div class="line">es             0x0	0</div><div class="line">fs             0x0	0</div><div class="line">gs             0x0	0</div><div class="line">(gdb) si  &lt;-- 执行前面的指令：xor %ax %ax。</div><div class="line">[   0:7c03] =&gt; 0x7c03:	mov    %ax,%ds  &lt;-- 即将要执行的指令。</div><div class="line">0x00007c03 <span class="keyword">in</span> ?? ()</div><div class="line">(gdb) info reg</div><div class="line">eax            0x0	0</div><div class="line">ecx            0x0	0</div><div class="line">edx            0x80	128</div><div class="line">ebx            0x0	0</div><div class="line">esp            0x6f2c	0x6f2c</div><div class="line">ebp            0x0	0x0</div><div class="line">esi            0x0	0</div><div class="line">edi            0x0	0</div><div class="line">eip            0x7c03	0x7c03</div><div class="line">eflags         0x46	[ PF ZF ]</div><div class="line">cs             0x0	0</div><div class="line">ss             0x0	0</div><div class="line">ds             0x0	0</div><div class="line">es             0x0	0</div><div class="line">fs             0x0	0</div><div class="line">gs             0x0	0</div><div class="line">(gdb)</div></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JOS/">JOS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/MIT-6-828/">MIT 6.828</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/blog/categories/xv6/">xv6</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-jos-lab1" data-title="MIT 6.828 JOS课程1：搭建实验环境" data-url="undefined"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'undefined'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>







  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 You Ji
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: false,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: /blog/
	}
</script>
<script src="/blog/js/require-2.1.6_jquery-1.9.1.min.js"></script>
<script src="/blog/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

</script>



  </div>
</body>
</html>